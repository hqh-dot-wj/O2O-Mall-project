---
inclusion: fileMatch
fileMatchPattern: '**/docs/**/*.md'
---

# 需求文档与设计文档规范

生成或编写**需求文档**、**设计文档**时遵循本规范。适用于：新功能规划、接口设计、页面设计、模块实现等需正式文档产出的场景。

---

## 1. 文档类型与产出要求

| 文档类型     | 说明                                 | 必含内容                                                     |
| ------------ | ------------------------------------ | ------------------------------------------------------------ |
| **需求文档** | 定义功能目标、用户故事、验收标准     | 用例图、活动图、状态图（若涉及状态流转）                     |
| **设计文档** | 定义技术方案、模块划分、数据流、部署 | 类图、时序图、组件图、部署图；若业务复杂，补充状态图、活动图 |

---

## 2. 必含的 7 类图

生成需求文档或设计文档时，**必须**按适用场景包含以下图（可用 Mermaid 或 PlantUML 等）：

| 图类型     | 用途                      | 适用文档  | 典型场景                         |
| ---------- | ------------------------- | --------- | -------------------------------- |
| **用例图** | 角色与用例关系、系统边界  | 需求文档  | 功能范围、谁用什么功能           |
| **类图**   | 实体、DTO、领域模型及关系 | 设计文档  | 数据结构、模块依赖               |
| **时序图** | 调用顺序、消息流          | 设计文档  | API 调用、前后端交互、服务间调用 |
| **组件图** | 模块/包划分与依赖         | 设计文档  | 架构分层、包结构                 |
| **部署图** | 运行环境、节点、部署关系  | 设计文档  | 服务部署、环境拓扑               |
| **状态图** | 状态及转换条件            | 需求/设计 | 订单状态、审批流、业务状态机     |
| **活动图** | 流程、分支、并行          | 需求文档  | 业务流程、操作步骤               |

**选图原则**：不强行凑图；若某图对当前场景无实际帮助，可省略并**在文档中说明省略原因**。

---

## 3. 文字描述规范（精准）

- **术语统一**：同一概念全文使用同一术语，避免混用（如「用户」与「会员」二选一）。
- **主谓宾完整**：每句有明确主语、谓语、宾语，避免模糊表述。
- **量化优先**：能用数字的用数字（如「3 秒内」「最多 100 条」），避免「较快」「较多」。
- **禁止歧义**：如「支持 A 和 B 的 C」需明确是「(A 和 B) 的 C」还是「A 和 (B 的 C)」。
- **引用准确**：引用代码、接口、表名时使用准确标识（如 `GET /api/xxx`、`sys_user`）。

---

## 4. 逻辑严谨性要求

- **因果清晰**：先因后果，条件与结论一一对应；若存在多分支，穷举或说明「其它情况」。
- **前后一致**：需求与设计、图与文字、各章节之间不得矛盾。
- **边界明确**：说明前置条件、后置条件、异常路径、超时/失败处理。
- **可验证**：验收标准可操作、可测试，避免「体验良好」「性能优秀」等主观描述。
- **层级分明**：先总体后局部，先概念后细节；章节编号与层级清晰。

---

## 5. 文档结构建议

### 5.1 需求文档

```
1. 概述（背景、目标、范围）
2. 角色与用例（用例图）
3. 业务流程（活动图）
4. 状态说明（状态图，若有）
5. 验收标准（可测试条目）
6. 非功能需求（性能、安全等，若适用）
```

### 5.2 设计文档

```
1. 概述（设计目标、约束）
2. 架构与模块（组件图）
3. 领域/数据模型（类图）
4. 核心流程时序（时序图）
5. 状态与流程（状态图、活动图，若适用）
6. 部署架构（部署图）
7. 接口/数据约定（可引用 OpenAPI、表结构）
```

---

## 6. 图的表达规范

- **图须有标题**：置于图上方或下方，格式如「图 1：XXX 用例图」。
- **图须有说明**：图中关键元素在正文中解释，不依赖「读图自明」。
- **与正文一致**：图中命名、关系须与文字描述一致，禁止图文不符。

---

## 7. 触发与适用

- **何时遵循**：用户要求生成需求文档、设计文档，或对 `docs/**`、`**/docs/**` 下的文档进行编写/补充时。
- **可省略场景**：纯修复、小改动、内部备忘类文档；若用户明确不需完整文档，可简化执行。

---

## 8. 文件命名规范

- **强制小写**：`docs/` 目录下新建的文档文件名必须全部使用小写字母，单词之间用连字符 `-` 分隔。
  - ✅ `payment-service-design.md`、`commission-requirements.md`
  - ❌ `PAYMENT_SERVICE_DESIGN.md`、`Commission_Requirements.md`
- **已有文件**：历史遗留的大写文件名不强制重命名，但新增文档必须遵循小写规范。
- **目录名**：同样使用小写 + 连字符，如 `docs/archive/`、`docs/e2e-tests/`。

---

## 9. 文档目录归类规范

新建需求文档或设计文档时，必须按文档类型放入对应子目录，禁止直接堆放在 `docs/` 根目录：

| 文档类型 | 目录                 | 示例                                                 |
| -------- | -------------------- | ---------------------------------------------------- |
| 需求文档 | `docs/requirements/` | `docs/requirements/payment-service-requirements.md`  |
| 设计文档 | `docs/design/`       | `docs/design/payment-notification-service-design.md` |

- **已有文件**：历史遗留在 `docs/` 根目录的文档不强制迁移，但新增文档必须归类。
- **跨文档引用**：使用相对路径引用，如设计文档引用需求文档：`[需求文档](../requirements/xxx.md)`。
- **其他类型**：测试指南放 `docs/testing/`，部署指南放 `docs/deployment/`，归档文档放 `docs/archive/`。按需创建子目录，保持一致性即可。
- **模块对齐**：当文档针对特定模块时，优先在对应类型目录下创建与 `src/module/` 同构的子路径。例如 `store/distribution` 模块的设计文档放 `docs/design/store/distribution/`，需求文档放 `docs/requirements/store/distribution/`。这样文档与代码一一对应，便于查找。

---

## 10. 缺陷分析前置检查规范

编写需求文档或设计文档中的「缺陷分析」章节时，**必须先查阅项目实际代码**，禁止凭模块内部代码推断项目全局结构。

### 10.1 C 端接口缺陷检查

分析某能力域模块是否缺少 C 端接口时，必须先检查 `src/module/client/` 目录：

- 按照后端规范 §13，C 端接口统一放在 `module/client/{能力域}/` 下，而非能力域模块内部。
- 因此，在能力域模块（如 `marketing/points/`）内看不到 `client/*` Controller 是正常的，不能直接判定为缺陷。
- **必做**：检查 `src/module/client/marketing/points/` 等对应路径是否已有 C 端 Controller。

### 10.2 跨模块依赖检查

分析跨模块缺陷时，必须确认：

- 被引用的 Service/Repository 是否已通过 Module exports 正确导出
- 调用方是否通过 Module imports 正确引入
- 不能仅凭「模块 A 的代码中没有看到模块 B 的引用」就判定为缺陷

### 10.3 Mermaid 图表编码规范

Mermaid 图表中禁止使用以下特殊字符，避免编码损坏：

- 禁止使用 `→`、`←`、`≤`、`≥`、`∈` 等 Unicode 特殊符号，改用纯 ASCII 文字描述
- 禁止在节点标签中使用 `<br/>`，改用空格或换行
- 节点标签中避免使用 `<`、`>` 符号，改用「大于」「小于」等文字
