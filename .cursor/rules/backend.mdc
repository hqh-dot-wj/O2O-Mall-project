---
description: NestJS åç«¯å¼€å‘è§„èŒƒï¼ˆå“åº”ã€å¼‚å¸¸ã€é”™è¯¯å·¥å…·ã€DTOã€Repositoryã€äº‹åŠ¡ã€Controllerã€æµ‹è¯•ã€æ€§èƒ½ã€å®‰å…¨ã€å¤šç§Ÿæˆ·ã€Client/Marketing æ¨¡å—åˆ’åˆ†ï¼‰
globs: apps/backend/**/*.ts
alwaysApply: false
---

# NestJS åç«¯å¼€å‘è§„èŒƒ

ç¼–è¾‘ `apps/backend` æ—¶éµå¾ªã€‚**å‚è€ƒï¼š`apps/backend/src/module/admin/system/user`**ã€‚

## ğŸ“¦ 1. ç»Ÿä¸€å“åº” API

```typescript
return Result.ok(data);
return Result.ok(data, 'æ“ä½œæˆåŠŸ');
return Result.ok({ rows, total }); // åˆ†é¡µ
return Result.fail(ResponseCode.BUSINESS_ERROR, 'é”™è¯¯ä¿¡æ¯');
throw new BusinessException(ResponseCode.BUSINESS_ERROR, 'éæ³•æ“ä½œ');
BusinessException.throwIf(condition, 'é”™è¯¯ä¿¡æ¯');
```

## ğŸš¨ 2. å¼‚å¸¸å¤„ç†

```typescript
import { BusinessException } from 'src/common/exceptions';
BusinessException.throwIfNull(user, 'ç”¨æˆ·ä¸å­˜åœ¨');
BusinessException.throwIf(age < 18, 'æœªæˆå¹´');
```

### 2.1 catch ä¸­å®‰å…¨è·å–é”™è¯¯ä¿¡æ¯ï¼ˆå¿…åšï¼‰

`catch (error)` çš„ `error` ä¸º `unknown` ç±»å‹ï¼Œç¦æ­¢ç›´æ¥è®¿é—® `error.message` / `error.stack`ã€‚ç»Ÿä¸€ä½¿ç”¨ `src/common/utils/error`ï¼š

```typescript
import { getErrorMessage, getErrorStack, getErrorInfo } from 'src/common/utils/error';

try {
  // ...
} catch (error) {
  // ä»…éœ€ message
  this.logger.error('æ“ä½œå¤±è´¥:', getErrorMessage(error));

  // éœ€ message + stack æ‰“æ—¥å¿—
  const { message, stack } = getErrorInfo(error);
  this.logger.error(message, stack);

  // æŠ›ç»™ä¸Šæ¸¸
  throw new BusinessException(ResponseCode.BUSINESS_ERROR, getErrorMessage(error));
}
```

| å‡½æ•° | ç”¨é€” |
|------|------|
| `getErrorMessage(error)` | å®‰å…¨æå–é”™è¯¯æ–‡æ¡ˆï¼ˆError / å¸¦ message å¯¹è±¡ / å…¶ä»–ï¼‰ |
| `getErrorStack(error)` | å®‰å…¨æå– stackï¼Œé Error è¿”å› undefined |
| `getErrorInfo(error)` | è¿”å› `{ message, stack? }`ï¼Œä¾¿äº logger.error(msg, stack) |

## ğŸ“„ 3. DTO åˆ†é¡µï¼ˆé¡¹ç›®æ ‡å‡†ï¼‰

```typescript
export class ListXxxDto extends PageQueryDto {
  @ApiProperty({ required: false })
  @IsOptional()
  @IsString()
  @Length(0, 30)
  userName?: string;

  @ApiProperty({ enum: StatusEnum, required: false })
  @IsOptional()
  @IsEnum(StatusEnum)
  @Transform(({ value }) => (value === '0' ? StatusEnum.NORMAL : value === '1' ? StatusEnum.STOP : value))
  status?: StatusEnum;
}
```

Service ä½¿ç”¨ `PaginationHelper.getPagination`ã€`buildDateRange`ã€`buildStringFilter`ã€`paginateWithTransaction`ã€‚åˆ†é¡µæ·±åº¦é™åˆ¶ offset â‰¤ 5000ï¼ˆè¶…é™æŠ›é”™ï¼‰ã€‚

## ğŸ—ï¸ 4. Repositoryï¼ˆé¡¹ç›®æ ‡å‡†ï¼‰

```typescript
@Injectable()
export class XxxRepository extends SoftDeleteRepository<SysUser, CreateInput, UpdateInput, Delegate> {
  constructor(prisma: PrismaService, cls: ClsService) {
    super(prisma, cls, 'sysUser', 'userId');
  }
}
```

## ğŸ”„ 5. äº‹åŠ¡

```typescript
import { Transactional } from 'src/common/decorators/transactional.decorator';
@Transactional()
async create(dto) { ... }
```

## ğŸ¨ 6. Controller

```typescript
@ApiTags('æ¨¡å—å')
@Controller('path')
@ApiBearerAuth('Authorization')
export class XxxController {
  @Api({ summary: 'xxx-åˆ—è¡¨', type: XxxListVo })
  @RequirePermission('system:xxx:list')
  @Get('list')
  findAll(@Query() query: ListXxxDto, @User() user: UserDto) {
    return this.xxxService.findAll(query, user.user);
  }

  @Operlog({ businessType: BusinessType.INSERT })
  @Post()
  create(@Body() dto: CreateXxxDto) {
    return this.xxxService.create(dto);
  }
}
```

è£…é¥°å™¨ï¼š`@Api`ã€`@RequirePermission`ã€`@RequireRole`ã€`@Operlog`ã€`@User()`ã€‚

## ğŸ“‚ 7. æ¨¡å—ç»“æ„

```
xxx/
  dto/  vo/  services/  xxx.repository.ts  xxx.service.ts  xxx.controller.ts  xxx.module.ts
```

## ğŸ“Š 8. æœ€ä½³å®è·µ

| ç»´åº¦ | åä¹ æƒ¯       | æœ€ä½³å®è·µ         |
| ---- | ------------ | ---------------- |
| é€»è¾‘ | å±‚å±‚ if-else | å«è¯­å¥ã€ç­–ç•¥æ¨¡å¼ |
| ä»£ç  | é­”æ³•å€¼       | æšä¸¾             |
| äº‹åŠ¡ | äº‹åŠ¡é‡Œè°ƒ RPC | äº‹åŠ¡ä»…åŒ…è£¹ DB    |
| DB   | å¾ªç¯æŸ¥åº“ N+1 | Where IN æ‰¹é‡    |

---

## ğŸ§ª 9. æµ‹è¯•è§„èŒƒï¼ˆå¿…åšï¼‰

å†™å®Œä¸€ä¸ªæ¨¡å—/åŠŸèƒ½åå¿…é¡»è¡¥å……æµ‹è¯•ï¼š

- **å•å…ƒæµ‹è¯•**ï¼šServiceã€å·¥å…·å‡½æ•°ã€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é¡»æœ‰å¯¹åº” `*.spec.ts`ï¼Œè¦†ç›–ä¸»è·¯å¾„ä¸å…³é”®è¾¹ç•Œã€å¼‚å¸¸åˆ†æ”¯ã€‚
- **è”åˆ/é›†æˆæµ‹è¯•**ï¼šæ¶‰åŠå¤šæ¨¡å—åä½œã€æ•°æ®åº“æˆ–å¤–éƒ¨ä¾èµ–çš„æµç¨‹ï¼Œåœ¨ `test/` ä¸‹ç¼–å†™ e2e æˆ– integration æµ‹è¯•ï¼ˆå¦‚ `xxx-flow.e2e-spec.ts`ã€`integration/xxx.spec.ts`ï¼‰ã€‚

| ç±»å‹          | æ”¾ç½®ä½ç½®                                  | é€‚ç”¨åœºæ™¯                                     |
| ------------- | ----------------------------------------- | -------------------------------------------- |
| å•å…ƒæµ‹è¯•      | ä¸æºæ–‡ä»¶åŒç›®å½• `xxx.spec.ts`              | Service æ–¹æ³•ã€Repositoryã€å·¥å…·å‡½æ•°ã€ä¸šåŠ¡è§„åˆ™ |
| é›†æˆ/è”åˆæµ‹è¯• | `test/integration/`ã€`test/*.e2e-spec.ts` | å¤šæ¨¡å—è”è°ƒã€å®Œæ•´ä¸šåŠ¡æµç¨‹ã€æ•°æ®åº“+å¤–éƒ¨ä¾èµ–    |

PR æ—¶æ–°é€»è¾‘åº”æœ‰å¯¹åº”å•æµ‹æˆ–é›†æˆæµ‹è¯•ï¼Œæ ¸å¿ƒ/èµ„é‡‘ç±»é€»è¾‘å»ºè®®äºŒè€…å…¼å¤‡ã€‚

---

## ğŸš€ 10. æ¥å£ä¸å¤§è¡¨æ€§èƒ½è§„èŒƒï¼ˆPR å¿…ç­”ï¼‰

**åŸåˆ™**ï¼šæ¥å£è¦å¯¹ã€Œæ•°æ®å¢é•¿ + è®¿é—®å¢é•¿ã€è´Ÿè´£ã€‚

### 10.1 è®¾è®¡ä¸‰é—®

1. ä¼šä¸ä¼šé«˜é¢‘è®¿é—®ï¼Ÿ2. ä¼šä¸ä¼šè®¿é—®å¤§è¡¨ï¼Ÿ3. æ•°æ®/QPS ç¿» 10 å€æ˜¯å¦å¯æ§ï¼Ÿ

### 10.2 QPS åˆ†çº§ï¼ˆæŒ‰æ¡£ä½è¯„ä¼°å³å¯ï¼‰

| æ¡£ä½ | QPS      | å…¸å‹           | è¦æ±‚                           |
| ---- | -------- | -------------- | ------------------------------ |
| ä½   | < 20     | åå°ã€é…ç½®     | ç®€å•æŸ¥è¯¢å¯æ¥å—                 |
| ä¸­   | 20 ~ 200 | åˆ—è¡¨ã€è¯¦æƒ…     | å‘½ä¸­ç´¢å¼•ã€è¯„ä¼°ç¼“å­˜ã€ç¦æ­¢æ·±åˆ†é¡µ |
| é«˜   | > 200    | é¦–é¡µã€æ ¸å¿ƒé“¾è·¯ | å¿…é¡»ç¼“å­˜/è¯»æ¨¡å‹ã€æ°´å¹³æ‰©å±•      |

**å¿…è¯„ä¼° QPS**ï¼šå¤§è¡¨ã€æµæ°´ã€è®¢å•ã€æ—¥å¿—ã€é«˜é¢‘åˆ—è¡¨ã€‚å…¶ä½™å¯é»˜è®¤ã€Œä½ã€ã€‚

### 10.3 å¤§è¡¨åå•ï¼ˆé»˜è®¤æŒ‰å¤§è¡¨è®¾è®¡ï¼‰

è®¢å•ã€æµæ°´ï¼ˆæ”¯ä»˜/é’±åŒ…/ç§¯åˆ†ï¼‰ã€æ“ä½œæ—¥å¿—ã€æ˜ç»†è¡¨ã€å†å²è¡¨ã€æ¶ˆæ¯è¡¨ã€‚

### 10.4 æ•°æ®é‡çº§

| çº§åˆ« | æ•°æ®é‡           | è¦æ±‚                              |
| ---- | ---------------- | --------------------------------- |
| D1   | < 10 ä¸‡          | offset åˆ†é¡µå¯æ¥å—                 |
| D2   | 10 ä¸‡ ~ 100 ä¸‡   | ç´¢å¼•ã€ç¦æ­¢å…¨è¡¨æ‰«æ                |
| D3   | 100 ä¸‡ ~ 1000 ä¸‡ | ç¦æ­¢ offset > 5000ã€æ¸¸æ ‡/æ—¶é—´åˆ†é¡µ |
| D4   | > 1000 ä¸‡        | åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»ã€ESã€å½’æ¡£          |

### 10.5 ç¦æ­¢é¡¹

- offset > 5000
- order by éç´¢å¼•å­—æ®µ
- å¤§è¡¨ `like %xxx%`ï¼ˆbuildStringFilter ç”¨ containsï¼Œå¤§è¡¨æ…ç”¨ï¼‰
- å•æ¥å£è¿”å› > 1000 æ¡ï¼ˆå¯¼å‡ºé¡»åˆ†é¡µæˆ–å¼‚æ­¥ï¼‰

### 10.6 æµæ°´è¡¨

åªå…è®¸ insertï¼Œç¦æ­¢ update/deleteã€‚æŸ¥è¯¢å¿…é¡»å¸¦æ—¶é—´èŒƒå›´ã€‚å¦‚éœ€çŠ¶æ€ä¿®æ­£ï¼Œä»…å…è®¸æ–°å¢ã€ŒçŠ¶æ€/ä¿®æ­£åŸå› ã€ç­‰å®¡è®¡å­—æ®µï¼Œç¦æ­¢æ”¹é‡‘é¢ç­‰æ ¸å¿ƒå­—æ®µã€‚

### 10.7 å‡çº§çº¢çº¿

å•è¡¨ > 500 ä¸‡ã€QPS > 200ã€P95 > 500msã€å…¨è¡¨æ‰«æã€offset > 5000ã€‚

### 10.8 PR å¿…ç­”

- QPS æ¡£ä½ï¼ˆä½/ä¸­/é«˜ï¼‰
- æ˜¯å¦å¤§è¡¨
- æ•°æ®é‡é¢„ä¼°
- æ˜¯å¦å‘½ä¸­ç´¢å¼• / æ·±åˆ†é¡µ
- ç¿» 10 å€åçš„å‡çº§æ–¹æ¡ˆ

---

## ğŸ›¡ï¸ 11. å®‰å…¨ä¸ç¨³å®šæ€§è§„èŒƒ

### 11.1 å¹‚ç­‰æ€§ï¼ˆP0ï¼‰

æ”¯ä»˜/ä¸‹å•/åˆ›å»ºç±»æ¥å£å¿…é¡»å¹‚ç­‰ã€‚å®ç°ï¼šå”¯ä¸€çº¦æŸã€Redis SetNXã€åˆ†å¸ƒå¼é”ã€çŠ¶æ€æœºã€‚

### 11.2 é˜²é‡å¤æäº¤ï¼ˆP0ï¼‰

è¡¨å•/ä¸‹å•ç­‰çŸ­æ—¶æ‹¦æˆªã€‚åç«¯ Redis è®°å½• `userId+ä¸šåŠ¡key`ï¼ŒTTL 3â€“5 ç§’ã€‚

### 11.3 æ•æ„Ÿæ•°æ®è„±æ•ï¼ˆP0ï¼‰

æ—¥å¿—å’Œæ¥å£è¿”å›ç¦æ­¢æ˜æ–‡ï¼šæ‰‹æœºå·ã€èº«ä»½è¯ã€é“¶è¡Œå¡ã€å¯†ç ã€‚è„±æ•ç¤ºä¾‹ï¼š`138****1234`ã€‚

### 11.4 é™æµï¼ˆP1ï¼‰

é«˜ QPS æ¥å£å¿…é¡»é™æµã€‚ç»´åº¦ï¼šIPã€ç”¨æˆ·ã€æ¥å£ã€‚å®ç°ï¼šä»¤ç‰Œæ¡¶ã€Nginxã€Gatewayã€Redisã€‚

### 11.5 è°ƒç”¨è¶…æ—¶ä¸å¼±ä¾èµ–ï¼ˆP1ï¼‰

RPC/HTTP å¿…é¡»è®¾è¶…æ—¶ï¼ˆå¦‚ 3â€“5sï¼‰ã€‚éæ ¸å¿ƒä¾èµ–åšå¼±ä¾èµ–ï¼šè¶…æ—¶/å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ã€‚

### 11.6 ç†”æ–­ä¸é™çº§ï¼ˆP2ï¼‰

ä¸‹æ¸¸å¼‚å¸¸/è¶…æ—¶æ¯”ä¾‹é«˜æ—¶ç†”æ–­ã€‚é™çº§ï¼šé»˜è®¤å€¼ã€ç¼“å­˜ã€ç®€åŒ–é€»è¾‘ã€‚é‡ç‚¹ï¼šæ”¯ä»˜ã€çŸ­ä¿¡ã€ç¬¬ä¸‰æ–¹ APIã€‚

### 11.7 é”™è¯¯ä¿¡æ¯éšè—ï¼ˆP1ï¼‰

ç”Ÿäº§ç¯å¢ƒä¸å‘å‰ç«¯è¿”å›å †æ ˆã€SQLã€å†…éƒ¨è·¯å¾„ã€‚ç»Ÿä¸€é”™è¯¯ç  + é€šç”¨æ–‡æ¡ˆï¼Œè¯¦æƒ…å†™æ—¥å¿—ã€‚

### 11.8 å‚æ•°ç™½åå•ï¼ˆP2ï¼‰

orderByã€where æ¡ä»¶ç™½åå•ï¼Œç¦æ­¢å‰ç«¯éšæ„ä¼ å…¥ä»»æ„å­—æ®µã€‚é˜²æ³¨å…¥ã€æ§æ€§èƒ½ã€‚

### 11.9 ç­¾åé˜²ç¯¡æ”¹ï¼ˆP2ï¼‰

é‡‘é¢ç­‰å…³é”®å­—æ®µç­¾åï¼ˆå‚æ•°+æ—¶é—´æˆ³+å¯†é’¥ï¼‰ã€‚æ”¯ä»˜/èµ„é‡‘ç±»æ¥å£å»ºè®®ä½¿ç”¨ã€‚

### 11.10 å¯è§‚æµ‹æ€§ï¼ˆP3ï¼‰

æ ¸å¿ƒæ¥å£ç›‘æ§ï¼šQPSã€P95 è€—æ—¶ã€é”™è¯¯ç‡ã€‚æ—¥å¿—å« traceIdã€userIdã€å…³é”®å‚æ•°ï¼ˆè„±æ•ï¼‰ã€‚

---

## ğŸ¢ 12. å¤šç§Ÿæˆ·ä¸æ¥å£åˆ†ç±»

Backend åŒæ—¶æœåŠ¡ **Admin åå°**ï¼ˆsystem/*ï¼‰ä¸ **Miniapp å°ç¨‹åº**ï¼ˆclient/*ï¼‰ã€‚æ¥å£åˆ†ä¸ºã€ŒæŒ‰ç§Ÿæˆ·éš”ç¦»ã€ä¸ã€Œä¸æŒ‰ç§Ÿæˆ·éš”ç¦»ã€ä¸¤ç±»ï¼Œæ–°å¢/ä¿®æ”¹æ¥å£æ—¶å¿…é¡»å…ˆåŒºåˆ†å¹¶æ ‡æ˜ã€‚

### 12.1 ä¸‰ç§æ¥å£ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **TenantScoped** | æ•°æ®æŒ‰å½“å‰ç§Ÿæˆ·éš”ç¦»ï¼›ç§Ÿæˆ·æ¥è‡ªè¯·æ±‚å¤´ `tenant-id` æˆ–ç™»å½•æ€ï¼›Repository ç”¨ BaseRepository/SoftDeleteRepository è‡ªåŠ¨è¿‡æ»¤ã€‚ | ç”¨æˆ·/è§’è‰²/éƒ¨é—¨åˆ—è¡¨ï¼›å°ç¨‹åºçš„è®¢å•ã€è´­ç‰©è½¦ã€å•†å“ã€é’±åŒ…ã€‚ |
| **PlatformOnly** | ä¸æŒ‰ç§Ÿæˆ·éš”ç¦»ï¼Œä»…å¹³å°æˆ–è¶…ç®¡å¯è°ƒï¼›å¿…é¡»é… `RequirePermission` æˆ–è§’è‰²æ ¡éªŒã€‚ | ç§Ÿæˆ·ç®¡ç†ã€ç§Ÿæˆ·å¥—é¤ã€åŒæ­¥å­—å…¸ã€ç›‘æ§ã€‚ |
| **TenantAgnostic** | ä¸ä¾èµ–å½“å‰ç™»å½•ç§Ÿæˆ·ï¼›ç§Ÿæˆ·ç”±å‚æ•°æˆ–è¿”å›å€¼å†³å®šã€‚ | `client/location/match-tenant`ã€`nearby-tenants`ã€‚ |

### 12.2 è·¯å¾„ä¸è°ƒç”¨æ–¹çº¦å®š

- **system/tenantã€system/tenant-package** â†’ ä¸€å¾‹ **PlatformOnly**ã€‚
- **client/location** ä¸‹ã€Œæ ¹æ®åæ ‡/ä½ç½®è§£ææˆ–åˆ—å‡ºç§Ÿæˆ·ã€çš„æ¥å£ â†’ **TenantAgnostic**ã€‚
- **client/** ä¸‹è®¢å•ã€è´­ç‰©è½¦ã€å•†å“ã€é’±åŒ…ç­‰ â†’ **TenantScoped**ï¼ˆç§Ÿæˆ·æ¥è‡ª header æˆ– bodyï¼Œä¸å‰ç«¯çº¦å®šä¸€è‡´ï¼‰ã€‚
- **system/** ä¸‹å…¶ä½™ä¸šåŠ¡ï¼ˆç”¨æˆ·ã€è§’è‰²ã€éƒ¨é—¨ç­‰ï¼‰â†’ **TenantScoped**ã€‚

### 12.3 æ ‡æ˜æ–¹å¼ï¼ˆå¿…åšï¼‰

- åœ¨ Controller ç±»æˆ–æ–¹æ³•ä¸Šç”¨ JSDoc æ ‡æ˜ï¼š`/** @tenantScope TenantScoped */` æˆ– `PlatformOnly` æˆ– `TenantAgnostic`ã€‚
- ä¸è·¯å¾„çº¦å®šä¸ä¸€è‡´æ—¶å¿…é¡»åœ¨ç±»æˆ–æ–¹æ³•ä¸Šæ˜¾å¼æ³¨é‡Šã€‚

### 12.4 æ–°å¢æ¥å£å‰è‡ªæ£€

1. ä¸»è¦è°ƒç”¨æ–¹ï¼šadmin / miniapp / bothï¼Ÿ
2. æ˜¯å¦æŒ‰ç§Ÿæˆ·éš”ç¦»ï¼Ÿâ†’ æ˜¯åˆ™ TenantScopedï¼Œå¦åˆ™ PlatformOnly æˆ– TenantAgnosticã€‚
3. PlatformOnly æ˜¯å¦å·²åŠ æƒé™ï¼Ÿ
4. Miniapp ä¸” TenantScoped æ—¶ï¼Œç§Ÿæˆ·æ¥æºæ˜¯ header è¿˜æ˜¯ body/queryï¼Ÿåœ¨æ³¨é‡Šæˆ–æ–‡æ¡£å†™æ˜ã€‚

### 12.5 æ•°æ®å±‚è¦æ±‚

- ç§Ÿæˆ·å†…æ¥å£ï¼šè®¿é—®ç§Ÿæˆ·éš”ç¦»è¡¨å¿…é¡»é€šè¿‡ç»§æ‰¿ BaseRepository/SoftDeleteRepository çš„ Repositoryï¼›ç¦æ­¢æ‰‹å†™ `prisma.xxx.findMany()` ä¸”ä¸åŠ ç§Ÿæˆ·æ¡ä»¶ï¼ˆé™¤éæ˜¾å¼è·¨ç§Ÿæˆ·ä¸”å·²åŠ æƒé™ï¼‰ã€‚
- åˆ›å»ºç§Ÿæˆ·éš”ç¦»æ•°æ®ï¼šç¦æ­¢ç”±å‰ç«¯ä¼ å…¥ `tenantId` è½åº“ï¼›ä» `TenantContext.getTenantId()` æˆ– `this.cls.get('tenantId')` å–ã€‚
- è·¨ç§Ÿæˆ·/å¹³å°æŸ¥è¯¢ï¼šç”¨é¡¹ç›®çº¦å®šçš„å¿½ç•¥ç§Ÿæˆ·æœºåˆ¶ï¼ˆå¦‚ TenantContext.run + setIgnoreTenantï¼‰ï¼Œå¹¶åšæƒé™æ ¡éªŒã€‚

---

## ğŸ“ 13. Client ä¸ Marketing æ¨¡å—èŒè´£åˆ’åˆ†

**åŸåˆ™ï¼šclient ç›®å½• = å°ç¨‹åºæ¥å£å…¨é›†ï¼›marketing ç›®å½• = è¥é”€èƒ½åŠ›åŸŸï¼ˆé…ç½®ã€è§„åˆ™ã€Serviceï¼‰ã€‚**

### 13.1 èŒè´£çº¦å®š

| æ¨¡å— | ç›®å½• | èŒè´£ | è·¯å¾„å‰ç¼€ |
|------|------|------|----------|
| **Client** | `module/client/` | æ‰€æœ‰å°ç¨‹åºç«¯æ¥å£çš„ Controller åŠ C ç«¯ä¸“ç”¨é€»è¾‘ | `client/*` |
| **Marketing** | `module/marketing/` | è¥é”€èƒ½åŠ›ï¼ˆä¼˜æƒ åˆ¸ã€ç§¯åˆ†ã€ç©æ³•ç­‰ï¼‰çš„ Serviceã€Repositoryã€è§„åˆ™é…ç½®ï¼›ä»…æä¾› **admin** ç«¯é…ç½®æ¥å£ | `admin/marketing/*` |

### 13.2 å¼ºåˆ¶è§„åˆ™

- **client ä¸‹å¿…é¡»åŒ…å«**ï¼šæ‰€æœ‰ `client/*` è·¯å¾„çš„ Controller å®ç°ï¼ŒåŒ…æ‹¬è¥é”€ C ç«¯æ¥å£ï¼ˆé¢†åˆ¸ã€ç­¾åˆ°ã€ç§¯åˆ†ã€æˆ‘çš„ä¼˜æƒ åˆ¸ç­‰ï¼‰ã€‚
- **marketing ä¸‹ç¦æ­¢**ï¼šç›´æ¥ä½¿ç”¨ `@Controller('client/*')` æš´éœ² C ç«¯æ¥å£ã€‚C ç«¯è¥é”€èƒ½åŠ›é€šè¿‡ Service å¯¹å¤–æä¾›ï¼Œç”± `module/client/marketing/` çš„ Controller è°ƒç”¨ã€‚
- **ä¾èµ–æ–¹å‘**ï¼š`client` â†’ `marketing`ï¼ˆclient ä¾èµ– marketing çš„ Serviceï¼‰ï¼Œç¦æ­¢ marketing ä¾èµ– clientã€‚

### 13.3 ç›®å½•ç»“æ„çº¦å®š

```
module/client/
â”œâ”€â”€ auth/          # ç™»å½•ã€ä¼šå‘˜è®¤è¯
â”œâ”€â”€ user/          # ç”¨æˆ·ä¿¡æ¯
â”œâ”€â”€ order/         # è®¢å•
â”œâ”€â”€ cart/          # è´­ç‰©è½¦
â”œâ”€â”€ product/       # å•†å“
â”œâ”€â”€ marketing/     # C ç«¯è¥é”€æ¥å£ï¼ˆè–„ Controllerï¼Œè°ƒç”¨ marketing Serviceï¼‰
â”‚   â”œâ”€â”€ coupon/    # é¢†åˆ¸ã€æˆ‘çš„ä¼˜æƒ åˆ¸
â”‚   â””â”€â”€ points/    # ç­¾åˆ°ã€ç§¯åˆ†è´¦æˆ·ã€ç§¯åˆ†ä»»åŠ¡
â”œâ”€â”€ ...
â””â”€â”€ client.module.ts

module/marketing/
â”œâ”€â”€ coupon/        # ä¼˜æƒ åˆ¸ Serviceã€Repositoryã€admin é…ç½®æ¥å£
â”œâ”€â”€ points/        # ç§¯åˆ† Serviceã€Repositoryã€admin é…ç½®æ¥å£
â”œâ”€â”€ integration/   # è®¢å•ä¼˜æƒ è®¡ç®— Serviceï¼ˆä¾› order è°ƒç”¨ï¼‰
â””â”€â”€ ...
```

### 13.4 æ–°å¢ C ç«¯è¥é”€æ¥å£æ—¶

1. åœ¨ `module/client/marketing/{coupon|points}/` ä¸‹æ–°å¢æˆ–æ‰©å±• Controllerã€‚
2. æ³¨å…¥å¹¶è°ƒç”¨ `module/marketing` å¯¼å‡ºçš„ Serviceã€‚
3. è·¯å¾„ä½¿ç”¨ `client/marketing/xxx`ï¼Œå®ˆå«ä½¿ç”¨ `MemberAuthGuard`ï¼Œè£…é¥°å™¨ä½¿ç”¨ `@Member()`ã€‚

### 13.5 è¿ç§»æŒ‡å¼•

è‹¥å½“å‰ C ç«¯è¥é”€æ¥å£ä»åœ¨ `module/marketing` ä¸­ï¼Œéœ€æŒ‰ **`docs/CLIENT_MARKETING_MIGRATION_SPEC.md`** æ‰§è¡Œè¿ç§»ï¼Œä½¿ç»“æ„ç¬¦åˆæœ¬èŠ‚çº¦å®šã€‚
