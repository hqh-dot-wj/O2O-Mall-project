# 营销活动预览功能测试指南

## 测试前准备

### 1. 启动开发环境

```bash
# 启动小程序客户端（端口 9000）
cd apps/miniapp-client
npm run dev:h5

# 启动管理后台（另一个终端）
cd apps/admin-web
npm run dev
```

### 2. 确认环境配置

- 小程序 H5 运行在: `http://localhost:9000`
- Admin 后台运行在: `http://localhost:xxxx`（根据你的配置）

## 测试场景

### 场景 1: 新建营销活动 - 卡片预览

**步骤:**
1. 登录管理后台
2. 进入"营销商品管理"页面
3. 点击"生产营销商品"按钮
4. 选择玩法模板（如"拼团"）
5. 点击"选择"按钮，选择一个商品
6. 配置规则参数：
   - 价格: 99
   - 拼团人数: 3
   - 有效期: 30天

**预期结果:**
- ✅ 右侧预览区域实时显示卡片
- ✅ 卡片显示活动价格 ¥99
- ✅ 卡片显示"3人成团"标签
- ✅ 卡片显示"有效期30天"标签
- ✅ 修改任何参数，预览立即更新

### 场景 2: 新建营销活动 - 商品详情预览

**步骤:**
1. 继续场景 1 的配置
2. 点击预览区域上方的"商品详情预览"按钮
3. 观察预览效果

**预期结果:**
- ✅ 预览切换到商品详情页面样式
- ✅ 显示商品轮播图
- ✅ 显示营销活动卡片（带活动标签）
- ✅ 显示活动价格和原价对比
- ✅ 显示商品基础信息
- ✅ 如果商品有多规格，显示规格选择区域
- ✅ 修改左侧配置，右侧实时更新

### 场景 3: 切换预览模式

**步骤:**
1. 在"卡片预览"和"商品详情预览"之间来回切换
2. 修改配置参数
3. 观察两种预览模式的更新

**预期结果:**
- ✅ 切换流畅，无卡顿
- ✅ 两种模式都能实时更新
- ✅ 数据保持一致

### 场景 4: 未选择商品时的限制

**步骤:**
1. 新建营销活动
2. 选择玩法模板
3. **不选择商品**
4. 尝试点击"商品详情预览"按钮

**预期结果:**
- ✅ "商品详情预览"按钮被禁用（灰色）
- ✅ 只能使用"卡片预览"模式
- ✅ 选择商品后，按钮变为可用

### 场景 5: 编辑已有配置

**步骤:**
1. 在营销商品列表中，点击某个已有配置的"配置"按钮
2. 观察预览效果
3. 修改配置参数
4. 切换预览模式

**预期结果:**
- ✅ 加载已有配置数据
- ✅ 预览显示当前配置效果
- ✅ 可以正常切换预览模式
- ⚠️ 商品信息可能不完整（已知限制）

### 场景 6: 不同玩法模板测试

**测试模板:**
- 拼团 (GROUP_BUY)
- 秒杀 (SECKILL)
- 课程 (COURSE)
- 打卡 (PUNCH_CARD)

**步骤:**
1. 分别创建不同玩法的营销活动
2. 配置各自的规则参数
3. 在两种预览模式下查看效果

**预期结果:**
- ✅ 不同玩法显示不同的活动标签
- ✅ 根据规则显示不同的特性标签
- ✅ 价格和规则正确显示

## 常见问题排查

### 问题 1: 预览页面显示"配置预览加载中..."不消失

**可能原因:**
- 小程序 H5 未启动
- 端口配置错误
- postMessage 通信失败

**解决方法:**
1. 检查小程序是否在 `localhost:9000` 运行
2. 打开浏览器控制台，查看是否有跨域错误
3. 检查 `config-operate-drawer.vue` 中的 `previewUrl` 配置

### 问题 2: 修改配置后预览不更新

**可能原因:**
- watch 监听失败
- iframe 未正确加载
- postMessage 发送失败

**解决方法:**
1. 打开浏览器控制台，查看是否有 JavaScript 错误
2. 检查 `usePreview` Hook 是否正常工作
3. 在预览页面控制台查看是否收到消息

### 问题 3: 商品详情预览按钮无法点击

**可能原因:**
- 未选择商品
- `model.serviceId` 为空

**解决方法:**
1. 确保已点击"选择"按钮并选择了商品
2. 检查 `model.serviceId` 是否有值

### 问题 4: 切换预览模式后页面空白

**可能原因:**
- 新预览页面路由不存在
- 页面加载失败

**解决方法:**
1. 确认 `apps/miniapp-client/src/pages/preview/product-detail.vue` 文件存在
2. 检查小程序路由配置
3. 重启小程序开发服务器

## 性能测试

### 测试点:
1. **实时更新延迟**: 修改配置到预览更新的时间 < 100ms
2. **切换模式速度**: 切换预览模式的时间 < 500ms
3. **内存占用**: 长时间使用不应有明显内存泄漏

### 测试方法:
```javascript
// 在浏览器控制台执行
console.time('preview-update');
// 修改配置
console.timeEnd('preview-update');
```

## 浏览器兼容性测试

**测试浏览器:**
- ✅ Chrome (推荐)
- ✅ Edge
- ✅ Firefox
- ✅ Safari

**注意事项:**
- 某些浏览器可能对 postMessage 有限制
- 建议使用最新版本浏览器

## 测试检查清单

- [ ] 卡片预览模式正常工作
- [ ] 商品详情预览模式正常工作
- [ ] 预览模式切换流畅
- [ ] 实时更新功能正常
- [ ] 未选择商品时按钮正确禁用
- [ ] 不同玩法模板预览正确
- [ ] 编辑模式预览正常
- [ ] 无控制台错误
- [ ] 性能表现良好
- [ ] 多浏览器兼容

## 反馈问题

如果发现问题，请记录以下信息：
1. 操作步骤
2. 预期结果
3. 实际结果
4. 浏览器版本
5. 控制台错误信息（如有）
6. 截图或录屏
