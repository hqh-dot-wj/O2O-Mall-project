# 佣金模块 (Commission Module) 技术文档

---

### 📂 1. 文件树与作用简述
```text
commission/
├── commission.processor.ts     # BullMQ 异步处理器，负责离线计算佣金，保障主流程性能
├── commission.repository.ts    # 数据库访问层，封装 fin_commission 表的 CRUD 逻辑
├── commission.service.ts       # 核心业务逻辑，包含分佣策略算法、结算规则、限额校验等
├── commission.processor.spec.ts # 处理器单元测试
├── commission.service.spec.ts  # 服务层单元测试
└── commission.service.advanced.spec.ts # 包含边界条件（跨店、限额）的高级逻辑测试
```

---

### 🗄️ 2. 数据库表及逻辑关联
模块主要涉及以下表及逻辑链路：

| 表名 | 作用 | 逻辑关联 |
| :--- | :--- | :--- |
| `fin_commission` | **分佣表** | 核心数据表。记录每一笔订单生成的 L1/L2 佣金明细及状态。 |
| `oms_order` | **订单表** | 触发源。提供订单金额、商品明细 (`oms_order_item`) 及分享人 (`shareUserId`)。 |
| `ums_member` | **会员表** | 关系链。通过 `parentId` 和 `indirectParentId` 确定 L1 (直推) 和 L2 (间推) 受益人。 |
| `sys_dist_config` | **分销配置** | 策略源。定义租户级别的 L1/L2 佣金比例、跨店分销开关及限额。 |
| `pms_tenant_sku` | **商品配置** | 基础额度。通过 SKU 的 `distMode` (比例/固定) 确定该商品的佣金计算基数。 |
| `fin_wallet` | **钱包表** | 资金归宿。已结算的佣金通过 `WalletService` 最终入账到受益人余额。 |

**核心逻辑图示：**
`支付回调` ➔ `BullMQ 队列` ➔ `CommissionProcessor` ➔ `CommissionService.calculateCommission` ➔ `事务持久化 fin_commission`

---

### 🔌 3. 核心接口与业务闭环

#### **3.1 佣金触发与计算 (异步重试机制)**
*   **`triggerCalculation(orderId, tenantId)`**
    *   **关键词**：`BullMQ`, `Event-Driven`
    *   **业务闭环**：在订单支付成功后，将分佣任务推入 `CALC_COMMISSION` 队列，通过异步解耦降低支付接口响应延迟。
*   **`calculateCommission(orderId, tenantId)`**
    *   **关键词**：`Multi-Level`, `Self-Purchase Check`, `Rules Engine`
    *   **业务闭环**：核心计算链路。执行自购检测、黑名单校验、LC1/L2 推荐人检索，并根据商品分佣基数计算最终金额，生成 `FROZEN` 状态记录。

#### **3.2 跨店分销与并发限额控制**
*   **`checkDailyLimit(tenantId, beneficiaryId, amount, limit)`**
    *   **关键词**：`SELECT FOR UPDATE`, `Atomic Limit`, `Cross-Tenant`
    *   **业务闭环**：通过数据库**行锁**实现严格的日限额校验。确保在高并发场景下，跨店分销的佣金发放不会超出租户设定的单日上限。

#### **3.3 结算状态机管理**
*   **`updatePlanSettleTime(orderId, eventType)`**
    *   **关键词**：`Freeze Period`, `Post-Action`
    *   **业务闭环**：当订单执行“确认收货”或“核销”时，根据商品类型（实物 T+7 / 服务 T+1）更新佣金的计划结算时间。
*   **`cancelCommissions(orderId)`**
    *   **关键词**：`Rollback`, `Refund Handling`
    *   **业务闭环**：处理退款闭环。对未结算的佣金执行 `CANCELLED`；对已入账佣金，调用钱包服务执行余额**倒扣**，形成财务闭环。

---

### 🛡️ 4. 安全审计与逻辑严谨性 (Security Audit)

本模块涉及核心资金操作，经逻辑审计，存在以下潜在风险点及防御建议：

#### **4.1 资金并发“第一笔”漏洞**
*   **风险描述**：`checkDailyLimit` 使用 `SELECT SUM(...) FOR UPDATE`。在当天首笔跨店单据生成前，该 SQL 无法命中行锁。高并发下，多笔订单可能同时读取到 `SUM=0` 从而绕过限额逻辑。
*   **攻击场景**：利用毫秒级并发支付，击穿租户设定的日限额，造成严重超发。
*   **改进建议**：在 `fin_commission` 表之外引入一个专门的 `fin_user_daily_quota` 计数器表，通过锁定具体的用户配额行而非聚合结果来实现强一致性。

#### **4.2 佣金上限“熔断”缺失**
*   **风险描述**：系统计算 L1+L2 佣金时，仅依赖配置比例，缺乏对订单实付金额的最终比例校验。
*   **攻击场景**：若后台分销配置或商品 SKU 佣金配置被恶意篡改（如比例设为 >100%），系统将产生远超订单金额的亏损。
*   **改进建议**：在持久化前增加硬性“熔断”逻辑：`Sum(Commissions) <= Order.ActualAmount * MaxSystemRatio(e.g., 50%)`。

#### **4.3 幂等性与“静默忽略”风险**
*   **风险描述**：`calculateCommission` 使用 `upsert` 且 `update: {}`。虽防止了重复发放，但也屏蔽了异常重试时的修正机会。
*   **潜在问题**：若首笔计算因配置错误生成了 0 元佣金，后续重试将因 `upsert` 逻辑无法更新数据。
*   **改进建议**：记录计算版本号或增加状态校验，仅在 `PENDING` 状态下允许重算覆盖。

#### **4.5 交叉受益人导致的死锁 (Deadlock Risk)**
*   **风险描述**：`calculateCommission` 处理 L1/L2 佣金时，锁定受益人配额的顺序完全依赖订单推荐链。
*   **攻击场景**：当 A 推荐 B 且 B 推荐 A 的复杂链路同时产生订单时，两个事务会因互相等待对方持有的行锁而导致死锁。
*   **改进建议**：在事务启动初期，预先提取所有潜在受益人 ID，并按固定顺序（如 ID 升序）一次性执行锁定，破坏死锁的“循环等待”条件。

#### **4.6 异步结算与退款的“竞态条件”**
*   **风险描述**：`cancelCommissions` 并非原子操作。在循环回滚佣金时若发生中断，会导致部分佣金回收失败。
*   **业务漏洞**：用户获得退款的同时，仍持有了部分已结算的佣金，产生财务损失。
*   **改进建议**：将 `cancelCommissions` 标记为 `@Transactional`，确保退款触发的所有佣金回滚在同一个原子操作内完成。

#### **4.8 钱包余额不足导致的回滚挂起**
*   **风险描述**：当订单退款触发佣金回滚时，若该受益人已将余额提现或消费，`deductBalance` 可能因为余额不足而抛出异常。
*   **业务漏洞**：回滚失败会导致退款流程卡死，或造成系统佣金与真实钱包状态永久失衡。
*   **改进建议**：财务系统应允许“负余额”存在（作为对用户的债权），或建立专门的“待回收佣金”台账，在用户下次入账时优先抵扣。

#### **4.9 部分退款分佣逻辑缺失**
*   **风险描述**：`cancelCommissions` 目前采用“一刀切”策略，未细化支持按商品比例回滚佣金。
*   **场景漏洞**：在一个多商品订单中，发生单件商品退款时，系统无法精准回收对应比例的佣金，易引发客诉或坏账。
*   **改进建议**：重构分佣结构，将佣金记录关联至具体的 `order_item_id`，实现商品级的精准分佣与回收。

#### **4.10 精度舍入偏差累加风险**
*   **风险描述**：在 L1/L2 的多级计算中，过早使用 `toDecimalPlaces(2)` 执行舍入。
*   **财务风险**：在大规模交易下，微小的舍入误差（0.001级）累加后会导致平台总账不平。
*   **改进建议**：内部计算全程保持 4-6 位高精度，仅在最终入账（写入钱包）时通过标准舍入规则（如银行家舍入法）处理为 2 位金额。

#### **4.11 结算时间操纵风险**
*   **风险描述**：`updatePlanSettleTime` 缺乏当前状态校验，直接覆盖结算时间。
*   **安全隐患**：若攻击者通过触发虚假事件（如快速确认收货后又申请售后重置），可能扰乱结算保护期。
*   **改进建议**：增加单向状态控制，结算时间一旦确定，除非管理员权限或特定逆向流程，否则禁止缩短（仅允许推迟）。
