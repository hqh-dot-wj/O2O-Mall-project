# LBS (Location Based Services) 模块总览

## 📂 文件树 with 功能简述
```text
lbs/
├── geo/           # 地理空间运算核心（PostGIS 适配层）
├── region/        # 行政区划管理（省市区基础维度数据）
├── station/       # 服务网点与地理围栏业务逻辑
└── lbs.module.ts  # 模块定义：聚合 LBS 相关服务、仓储及控制器
```
- **lbs.module.ts**: 统一向外暴露 `GeoService`, `RegionService`, `StationService`，支撑整个 O2O 平台的地理位置服务需求。

## 🗄️ 数据库表与逻辑关联

| 表名 | 作用 | 逻辑关联 |
| :--- | :--- | :--- |
| `sys_region` | 行政区划字典 | 作为地址级联的基础，支撑网点（Station）的行政归属划分。 |
| `sys_station` | 经营网点实体 | 业务主体，关联所属租户 ID，是服务履约的物理节点。 |
| `sys_geo_fence` | 空间几何围栏 | 与 `sys_station` 关联，定义网点的物理服务边界。 |

**模块逻辑关联**：
1. **维度基准**：由 `region` 模块提供标准地址编码（PCA）。
2. **空间赋能**：`geo` 模块为 `station` 提供底层的 PostGIS 空间运算符支持。
3. **业务实现**：`station` 模块整合上述功能，实现“人-站-范围”的业务撮合闭环。

## 🔌 核心接口作用 (Module Level)

| 核心组件 | 技术关键词 | 业务闭环能力 |
| :--- | :--- | :--- |
| **GeoService** | `PostGIS`, `WKT` | **数字化空间：** 提供坐标到几何对象的转换，计算两点间精确球面距离。 |
| **RegionService** | `Redis`, `Cache` | **标准化地址：** 全量中国行政区划树查询，支持 C 端收货地址与后台网点覆盖地区的标准映射。 |
| **StationService** | `Fence`, `Dispatcher` | **网点准入：** 判断用户坐标是否落入某网点的服务围栏内，实现自动分单与派单。 |

## 💡 核心逻辑重点
- **高性能空间检索**：全量使用 PostGIS 空间索引（GIST），支持海量围栏下的秒级点选匹配。
- **高可用设计**：行政区划数据全量 Redis 预热，站点信息支持多租户隔离与软删除。
- **技术解耦**：将通用的空间算法（geo）与具体的业务对象（station）分离，便于后期扩展如“配送员实时位置”等功能。
