# PMS Category 商品分类模块

该模块负责管理商品的**多级分类树**，是商品库（PMS）的核心导航与属性绑定基础。

## 📂 文件树与功能简述

```text
category/
├── dto/                   # DTO：定义分类创建、更新及列表查询参数
├── vo/                    # VO：定义返回前端的分类树与列表结构
├── category.controller.ts # 控制器：对外暴露分类树、详情及 CRUD 接口
├── category.repository.ts # 仓储层：封装自关联树查询及跨表引用检查逻辑
├── category.service.ts    # 服务层：核心业务（递归构树、缓存维护、业务规则校验）
└── category.module.ts     # 模块配置：全局注册与依赖管理
```

---

## 🗄️ 数据库表与逻辑关联

模块围绕树形结构建模，涉及核心表及其关联关系：

1.  **PmsCategory (商品分类表)**：
    *   **自关联逻辑**：通过 `parentId` 实现 `1:N` 父子嵌套。
    *   **属性绑定**：通过 `attrTemplateId` 关联 `PmsAttrTemplate`，实现“不同分类决定不同属性表单”的闭环。
2.  **核心关联链**：
    *   **商品关联**：`PmsCategory` -> `PmsProduct`。商品发布必须归属于末级分类。
    *   **级联安全**：删除操作受限。若存在下级分类或商品引用，业务逻辑将强制阻断。

---

## 🛠️ 核心接口作用

| 接口名称 | 技术关键词 | 业务闭环描述 |
| :--- | :--- | :--- |
| **findTree** | `@Cacheable` / 递归 | **高性能导航闭环**。通过 Redis 缓存分类全集并递归构树，支撑移动端和后台的高频分类展示需求。 |
| **create/update** | `@CacheEvict` / 事务 | **配置更新闭环**。实现分类信息的事务化入库，更新后自动清空 Redis 缓存，保证全网数据强一致性。 |
| **remove** | 子集与引用强校验 | **结构完整性闭环**。前置校验下级分类和 SPU 引用，防止分类树空洞及业务孤儿记录。 |
| **findAll** | 分页助手 / 平铺查询 | **后台运维闭环**。在指定父节点下进行分页模糊搜索，方便管理员精准定位并调整分类顺序或元数据。 |

---

## 💡 核心逻辑亮点

*   **高性能缓存设计**：利用 `@Cacheable` 装饰器对分类树进行内存级缓存，单次请求响应可达毫秒级，极大缓解数据库 QPS 压力。
*   **严谨的业务防御**：在 `remove` 逻辑中显式实现了两层防御（HasChildren & IsUsedByProducts），确保作为元数据中心的分类体系稳健安全。
*   **模型解耦**：属性模板（AttrTemplate）与分类的解耦绑定，使得不同层级的分类可以灵活继承或独立拥有其独有的规格定义。
