# PMS Attribute 属性管理模块

该模块负责管理商品的**属性模板**与**属性项**，为不同分类的商品提供标准化的规格（Spec）和参数（Param）定义。

## 📂 文件树与功能简述

```text
attribute/
├── dto/
│   └── attribute.dto.ts    # 数据传输对象：定义模板与属性的输入校验
├── attribute.controller.ts # 控制器：对外暴露模板 CRUD 与分类关联查询接口
├── attribute.repository.ts # 仓储层：封装 PmsAttribute 表的底层查询（如按分类找属性）
├── attribute.service.ts    # 服务层：核心业务逻辑（事务化处理模板与属性的联动更新）
└── template.repository.ts  # 仓储层：封装 PmsAttrTemplate 表的底层查询与引用校验
```

---

## 🗄️ 数据库表与逻辑关联

模块核心涉及 **Prisma** 定义的三张表及其层次化关系：

1.  **PmsAttrTemplate (属性模板表)**：
    *   作为“属性组”的容器（如：“手机模板”、“家政服务模板”）。
    *   通过 `attrTemplateId` 与商品分类进行绑定。
2.  **PmsAttribute (属性项定义表)**：
    *   归属于特定模板（`1:N` 关系）。
    *   定义属性的**使用类型**（`PARAM`-基本参数 / `SPEC`-销售规格）和**录入方式**。
3.  **逻辑关联链**：
    *   **分类绑定**：`PmsCategory` -> `PmsAttrTemplate`。商品选择分类后，自动加载对应的属性模板。
    *   **商品引用**：`PmsAttribute` -> `PmsProductAttrValue`。商品发布时，根据属性项定义填写的具体值。

---

## 🛠️ 核心接口作用

| 接口名称 | 技术关键词 | 业务闭环描述 |
| :--- | :--- | :--- |
| **create/update** | `@Transactional` | **配置下发闭环**。在一个事务内完成模板基本信息更新及属性项的批量增删改，确保元数据一致性。 |
| **getByCategory** | 多表联动查询 | **动态表单闭环**。根据移动端或后台选定的分类 ID，反查其绑定的属性项，实现商品编辑页的动态表单渲染。 |
| **remove** | 引用约束校验 | **数据安全闭环**。在删除模板前强校验 `PmsCategory` 是否存在引用，防止业务链路数据孤儿。 |
| **findAll** | 分页助手 / 排序 | **后台管理闭环**。提供基于关键词搜索和创建时间排序的模板配置列表，支持高效运维。 |

---

## 💡 核心逻辑亮点

*   **Diff 更新策略**：在 `update` 逻辑中，通过对比输入 ID 集实现属性项的“保留、删除、新增”自动化处理，降低前端交互复杂度。
*   **标准化约束**：通过 `usageType` 区分规格与参数，为下游 SKU 生成逻辑（规格决定 SKU）和详情展示逻辑（参数纯展示）提供数据标准。
