# Risk 风控模块

该模块负责系统的安全性与业务合规性校验，目前核心逻辑侧重于**下单风控**，通过滑动窗口和频率统计防止刷单及恶意攻击。

## 📂 文件树与功能简述

```text
risk/
├── risk.module.ts      # 模块入口：全局注册并导出 RiskService
└── risk.service.ts    # 核心逻辑：实现高频检测、IP 聚集分析等风控算法
```

---

## 🗄️ 数据库与中间件逻辑

该模块目前**未直接操作物理数据库表**，而是基于 **Redis** 实现高性能的实时风控态势感知：

1.  **Redis 状态存储**：
    *   `risk:freq:order:{tenantId}:{memberId}`: 记录单用户在特定租户下的下单频率（1小时 TTL）。
    *   `risk:ip:users:{today}:{ip}`: 记录单 IP 下每日活跃的唯一会员集合（24小时 TTL）。
2.  **逻辑关联**：
    *   **会员关联**：风险动作直接锚定 `UmsMember`。
    *   **租户隔离**：风控策略在租户维度（`tenantId`）进行垂直隔离，确保 SAAS 环境下的策略独立性。

---

## 🛠️ 核心接口作用

| 接口名称 | 技术关键词 | 业务闭环描述 |
| :--- | :--- | :--- |
| **checkOrderRisk** | 聚合校验、门面模式 | **风控总闸**。在下单前置环节点调用，统一调度频率控制、IP 聚集等子模块。 |
| **checkFrequency** | Redis INCR / EXPIRE | **下单限频**。限制单用户每小时最大下单数（默认 10 单），有效防止脚本抢单。 |
| **checkIpClustering** | Redis SADD / SCARD | **IP 聚集检测**。识别同一 IP 下关联的多个异常账号（默认 5 人），阻断刷单工场行为。 |

---

## 💡 核心逻辑亮点

*   **非阻塞审计**：逻辑优先使用 Redis 原子操作，确保风控检测不成为订单路径的性能瓶颈。
*   **阶梯防护策略**：未来可扩展通过 `deviceId`（指纹）进行关联账户识别，实现更精准的“人机校验”闭环。
