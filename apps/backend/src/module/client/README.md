# C端 (Client) 业务总模块文档

模型名称：Gemini 2.0 Flash、模型大小：未知、模型类型：对话模型及其修订版本：2026-05-14

### **1. 文件树与作用简述 (File Tree & Architecture)**

```text
client/
├── address/    # 收货地址：用户多地址管理、LBS 距离辅助
├── auth/       # 认证中心：微信静默登录、手机号绑定、推荐关系链路同步
├── cart/       # 购物车：多租户隔离、失效商品过滤、Redis 快速角标同步
├── common/     # 公共基础：微信 API 深度封装、C 端 JWT 守卫/装饰器
├── finance/    # 财务中心：钱包资产预览、佣金明细、提现申请入口
├── location/   # 位置服务：PostGIS 电子围栏匹配、附近租户弧面距离算法
├── order/      # 订单引擎：结算计价、异步通知、超时关闭 (BullMQ)、分销归因
├── payment/    # 支付中心：微信预支付 (Prepay) 参数获取、支付回调幂等处理
├── product/    # 商品中心：租户差异化定价、营销活动动态聚合、多级缓存策略
├── service/    # 预约槽位：30分钟粒度服务预测与 Redis 预占用锁定
├── upgrade/    # 会员升级：裂变推荐码生成、团队业绩统计、等级自动晋升
├── user/       # 用户档案：个人信息获取与层级状态补全
└── client.module.ts # 核心枢纽：C 端全量子模块的依赖编排与导出
```

---

### **2. 数据库表与逻辑关联 (Database & Relationships)**

C 端模块采用了**高度去中心化且强关联**的数据模型，核心链路如下：

1. **账户层 (`UmsMember` + `SysSocialUser`)**：通过微信 `openid` 实现身份与业务会员的 1:1 映射。
2. **位置层 (`SysTenantGeo` + `GeoStation`)**：将用户空间几何坐标转化为特定 `tenantId` 业务上下文。
3. **交易层 (`OmsOrder` + `OmsOrderItem`)**：聚合 `PmsTenantSku` 的实时价格与库存，生成订单快照。
4. **资金层 (`FinWallet` + `FinCommission`)**：基于订单成功状态，触发自动化的分销收益结算。

---

### **3. 核心业务闭环 (Business Closure)**

| 核心流程 | 参与子模块 | 业务闭环描述 |
| :--- | :--- | :--- |
| **流量导入** | `auth` + `location` | 微信扫码进店 ➔ 自动识别归属人/站点 ➔ 静默完成账号注册与归因绑定。 |
| **选品预览** | `product` + `cart` | 浏览租户特定商品 ➔ 实时聚合营销价 ➔ 加购时异步刷新 Redis 缓存角标。 |
| **下单结算** | `order` + `service` | 锁定预约槽位 ➔ 执行 LBS 服务范围与库存双重校验 ➔ 开启超时自动取消任务。 |
| **支付收益** | `payment` + `finance` | 完成真实/Mock 支付 ➔ 订单转正 ➔ 异步分发分销佣金并统计团队业绩。 |

---

### **4. 安全审计与系统严谨性 (Security & Logic Audit)**

- **多维隔离架构**：全系模块强制基于 `member-jwt` 守卫，在数据库层面通过 `tenantId` + `memberId` 实现物理数据的水平与垂直双重隔离。
- **高并发稳定性方案**：
    - **缓存设计**：大规模应用 Redis 平衡 DB 压力（购物车角标、商品列表 MD5 分片缓存、预约槽位锁）。
    - **异步解耦**：利用 BullMQ 延迟队列处理非即时性任务（由于支付导致的订单通知、超时库存释放）。
- **逻辑缺陷与健壮性**：
    - *风险点*：归因关系（Referrer）依赖于首次注册或下单的原子性，需警惕缓存丢失导致的关系暂时漂移。
    - *精度控制*：财务计算全程强制使用 `Decimal` 类型，确保 C 端展示金额与后台结算零误差。
    - *容错控制*：微信 API 异步调用失败时采用静默降级策略，优先保障核心业务的主流程畅通。
