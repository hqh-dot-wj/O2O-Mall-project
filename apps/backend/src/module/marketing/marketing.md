# Marketing 营销核心模块 (MaaS)

## 📂 文件树与功能简述
```text
marketing/
├── asset/               # 履约中心：管理核销券、次卡等虚拟资产
├── config/              # 配置中心：门店商品与玩法模板的绑定配置
├── instance/            # 执行中心：活动参与记录及状态流转引擎
├── play/                # 策略中心：具体玩法的业务逻辑（拼团、升级等）
├── stock/               # 库存中心：基于 Redis Lua 的高并发名额控制
├── template/            # 元数据中心：系统支持的营销玩法蓝图
├── marketing.module.ts  # 模块聚合器：整合上述子模块
└── marketing.md         # 模块总览文档
```
- **核心定位**：一站式营销服务 (Marketing as a Service)，提供从玩法定义、活动配置到交易履约的全链路支撑。

## 🗄️ 数据库表与逻辑关联
模块通过四张核心表构建业务闭环：
1. **`PlayTemplate` (模板)**: 定义“有什么”，如拼团、秒杀。
2. **`StorePlayConfig` (配置)**: 定义“怎么卖”，将模板绑定到具体商品、设置价格与库存。
3. **`PlayInstance` (实例)**: 定义“谁参与”，记录用户参与活动的过程（支付、进度、成败）。
4. **`MktUserAsset` (资产)**: 定义“得什么”，活动成功后产出的核销凭证。

**逻辑流转**:
`Template` (蓝图) -> `Config` (门店应用) -> `Instance` (用户参与/支付) -> `Asset` (履约凭证) & `Wallet` (资金结算)。

## ⚙️ 核心业务闭环与技术关键词
| 业务阶段 | 技术关键词 | 业务流转能力 |
| :--- | :--- | :--- |
| **规则预检** | `Strategy Pattern`, `MemoryJoin` | 自动匹配玩法策略，跨模块关联商品与模板信息，实现配置级的强校验。 |
| **交易防超卖** | `Redis Lua`, `AtomicDecrement` | 在高并发下单瞬间执行名额锁定，确保营销资源不被穿透。 |
| **状态机流转** | `State Machine`, `@Transactional` | 严格管理 `PENDING_PAY` -> `PAID` -> `SUCCESS` 过程，确保资金、进度状态强一致。 |
| **权益转化** | `CrossModule`, `Workflow` | 实例成功后自动触发**资金入账（门店钱包）**与**权益发放（核销券资产）**，完成商业闭环。 |

---
*注：本模块高度解耦。新增玩法仅需在 `play/` 目录下扩展策略并注册至 `template/`，无需改动 `instance/` 状态机核心。*
