# Marketing Stock 营销库存/名额管理模块

## 📂 文件树与功能简述
```text
stock/
├── stock-strategy.ts     # 库存策略实现 (强互斥、懒校验及其策略工厂)
├── stock.module.ts       # 模块配置 (导出 StockService 供全营销模块使用)
├── stock.service.ts      # 核心引擎 (基于 Redis Lua 脚本的高并发原子扣减逻辑)
└── stock.md              # 模块文档
```
- **核心定位**：营销系统的“高并发流量闸门”，负责在高并发（如秒杀、拼团抢购）场景下保障营销名额扣减的**原子性**与**一致性**。

## 🗄️ 数据库表与逻辑关联
该模块主要作为缓存中间层，通过以下关联保障数据安全：
- **`StorePlayConfig.rules` (库存来源)**: 
    - 数据库存储营销活动的总库存值（JSON 字段如 `stock`）。
    - 模块通过 `syncFromDb` 机制将数据库库存懒加载同步至 Redis。
- **关联逻辑**: 
    - **Redis (核心存储)**: 实时存储动态变化的“热库存” Key（如 `mkt:stock:{configId}`）。
    - **Lua 策略**: 直接在 Redis 服务端运行指令，合并“读、算、写”操作，根治 N+1 及超卖顽疾。

## ⚙️ 核心接口与技术细节
| 核心能力 | 技术关键词 | 业务闭环能力 |
| :--- | :--- | :--- |
| **原子扣减** | `Redis Lua`, `Atomic` | **反超卖保障**：单请求内完成判断与扣减，承受万级 QPS 冲击而不发生超卖。 |
| **强/弱策略分发** | `StrongLock`, `LazyCheck` | **差异化履约**：实物商品采用 `STRONG_LOCK` (下单即锁名额)；虚拟服务采用 `LAZY_CHECK` (支付后真实扣减)。 |
| **缓存回补机制** | `SyncFromDb`, `Retry` | **高可用容灾**：当 Redis 缓存丢失时，自动回溯数据库重置库存并重试请求，确保业务不中断。 |
| **名额回收** | `IncrBy`, `SafetyIncrement` | **闭环完整性**：支持在订单取消、支付超时等场景下自动归还名额，提升资源利用率。 |

---
*注：本模块是营销底层最稳健的基石，通过 Redis 与 Lua 脚本的配合，为拼团、秒杀、砍价等高并发玩法提供实时、安全的名额锁定能力。*
