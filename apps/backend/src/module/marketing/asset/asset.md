# User Asset 用户资产模块

## 📂 文件树与功能简述
```text
asset/
├── dto/
│   └── asset.dto.ts      # 数据传输对象 (分页查询、基础结构)
├── vo/
│   └── asset.vo.ts       # 视图对象 (列表响应格式)
├── asset.controller.ts   # 控制器 (定义核销、查询等入口)
├── asset.module.ts       # 模块配置 (依赖注入及导出)
├── asset.repository.ts   # 仓储层 (Prisma 数据原子操作)
├── asset.service.ts      # 业务逻辑 (核销预检、生命周期管理)
└── asset.md              # 模块文档
```
- **核心定位**：营销系统的“履约中心”，负责管理用户通过活动获得的虚拟权益（券、次卡等）。

## 🗄️ 数据库表与逻辑关联
该模块主要操作以下核心表：
- **`MktUserAsset` (用户资产表)**: 
    - **逻辑关联**: 
        - 向上通过 `memberId` 关联 **会员系统** 的会员信息。
        - 向上通过 `playInstanceId` 或来源字段（通常在 Data 字段中）定位产生的 **营销方案/实例**。
        - 记录资产的动态余额 (`balance`)、状态 (`status`) 及过期时间 (`expireTime`)。

## ⚙️ 核心接口作用
| 接口 | 技术关键词 | 业务闭环能力 |
| :--- | :--- | :--- |
| **查询资产列表** | `PageQuery`, `FormatDate` | 实现用户端/管理端资产分布的快速对账与展示。 |
| **查询资产详情** | `AssertNotNull` | 获取特定资产的核销码、剩余金额等关键详情。 |
| **核销资产** | `@Transactional`, `AtomicDecrement` | 执行权益扣减，包含**有效期风控、状态预检、余额原子扣减**。当余额归零时自动完成生命周期闭环（状态流转至 `USED`）。 |
| **发放资产** | `Integration` | 接收支付回调或系统触发，为指定用户注入特定权益资产。 |

---
*注：本模块侧重于“资产账户”的管理，具体的发券规则和活动引擎逻辑位于 `marketing/play` 模块中。*
