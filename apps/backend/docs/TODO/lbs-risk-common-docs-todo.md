# LBS、Risk 和 Common 模块文档编写待办

> 日期：2026-02-22
> 模块路径：`src/module/lbs`、`src/module/risk`、`src/module/common`
> 文档目标路径：`docs/requirements/`、`docs/design/`

---

## 一、模块概述

### LBS（位置服务）模块

LBS 模块是 O2O 平台的核心基础设施，提供地理位置相关的能力。包含 3 个子模块：

| 子模块  | 路径           | 职责                               | 复杂度 | 代码文件数 |
| ------- | -------------- | ---------------------------------- | ------ | ---------- |
| geo     | `lbs/geo/`     | 地理空间运算核心（PostGIS 适配层） | 低     | 2          |
| region  | `lbs/region/`  | 行政区划管理（省市区基础维度数据） | 低     | 5          |
| station | `lbs/station/` | 服务网点与地理围栏业务逻辑         | 中     | 5          |

### Risk（风控）模块

Risk 模块是 O2O 平台的安全防护层，负责识别和拦截异常交易行为。当前实现包含 2 个核心风控规则：

| 规则         | 职责                                   | 复杂度 |
| ------------ | -------------------------------------- | ------ |
| 高频下单检测 | 限制单用户每小时最大下单数             | 低     |
| IP 聚集检测  | 检测同一 IP 下过多不同用户（刷单工场） | 低     |

### Common（公共基础设施）模块

Common 模块是整个后端系统的核心基础设施层，为所有业务模块提供通用能力。包含 3 个子模块：

| 子模块 | 路径            | 职责                                 | 复杂度 | 代码文件数 |
| ------ | --------------- | ------------------------------------ | ------ | ---------- |
| redis  | `common/redis/` | 缓存管理、分布式锁、缓存预热、防雪崩 | 中     | 3          |
| bull   | `common/bull/`  | 异步队列、任务调度、重试机制         | 中     | 2          |
| axios  | `common/axios/` | HTTP 客户端、IP 地理位置查询         | 低     | 2          |

---

## 二、文档编写状态

### LBS 模块

| 优先级 | 序号 | 文档类型    | 输出路径                                    | 状态   | 完成日期   |
| ------ | ---- | ----------- | ------------------------------------------- | ------ | ---------- |
| P0     | 1    | ✅ 需求文档 | `docs/requirements/lbs/lbs-requirements.md` | 已完成 | 2026-02-22 |
| P0     | 2    | ✅ 设计文档 | `docs/design/lbs/lbs-design.md`             | 已完成 | 2026-02-22 |

### Risk 模块

| 优先级 | 序号 | 文档类型    | 输出路径                                      | 状态   | 完成日期   |
| ------ | ---- | ----------- | --------------------------------------------- | ------ | ---------- |
| P0     | 1    | ✅ 需求文档 | `docs/requirements/risk/risk-requirements.md` | 已完成 | 2026-02-22 |
| P0     | 2    | ✅ 设计文档 | `docs/design/risk/risk-design.md`             | 已完成 | 2026-02-22 |

### Common 模块

| 优先级 | 序号 | 文档类型    | 输出路径                                          | 状态   | 完成日期   |
| ------ | ---- | ----------- | ------------------------------------------------- | ------ | ---------- |
| P0     | 1    | ✅ 需求文档 | `docs/requirements/common/common-requirements.md` | 已完成 | 2026-02-22 |
| P0     | 2    | ✅ 设计文档 | `docs/design/common/common-design.md`             | 已完成 | 2026-02-22 |

**文档完整性**：

- ✅ 架构组件图（1 个）
- ✅ 数据模型类图（1 个）
- ✅ 核心流程时序图（4 个：缓存预热、分布式锁、异步任务、IP 查询）
- ✅ 部署架构图（1 个）
- ✅ 缺陷改进方案（5 个，含代码示例）
- ✅ 架构改进方案（2 个：多级缓存、任务编排）
- ✅ 接口与数据约定
- ✅ 优先级总结和实施路线图
- ✅ 测试策略（单元测试和集成测试示例）

---

## 三、文档内容总结

### LBS 需求文档

- 3 个子模块概述（geo、region、station）
- 4 个角色定义和用例图
- 3 个业务流程活动图（网点创建、位置匹配、数据初始化）
- 现有功能详述（Geo、Region、Station 子模块的核心方法和数据结构）
- 13 个代码缺陷 + 3 个跨模块缺陷 + 6 个架构不足
- 市面对标分析
- 验收标准
- 演进建议（17 个任务分 4 阶段）

### LBS 设计文档

- 设计目标和约束
- 架构组件图
- 数据模型类图（3 个核心表）
- 4 个核心流程时序图（网点创建、位置匹配、数据初始化、距离计算）
- 部署架构图
- 7 个缺陷改进方案（含代码示例）
- 2 个架构改进方案
- 接口/数据约定
- 优先级总结和实施路线图

### Risk 需求文档

- 2 个核心风控规则概述（高频下单、IP 聚集）
- 4 个角色定义和用例图
- 3 个业务流程活动图（订单风控检测、高频下单检测、IP 聚集检测）
- 现有功能详述（核心方法、规则配置、Redis 数据结构）
- 8 个代码缺陷 + 4 个跨模块缺陷 + 6 个架构不足
- 市面对标分析
- 验收标准
- 演进建议（17 个任务分 4 阶段）

### Risk 设计文档

- 设计目标和约束
- 架构组件图
- 数据模型类图（3 个核心表）
- 3 个核心流程时序图（订单风控检测、规则配置、日志查询）
- 部署架构图
- 7 个缺陷改进方案（含代码示例）
- 2 个架构改进方案
- 接口/数据约定
- 优先级总结和实施路线图

### Common 需求文档

- 3 个子模块概述（redis、bull、axios）
- 4 个角色定义和用例图
- 4 个业务流程活动图（缓存预热、分布式锁、异步任务、IP 查询）
- 现有功能详述（Redis、Bull、Axios 子模块的核心方法）
- 15 个代码缺陷 + 3 个跨模块缺陷 + 5 个架构不足
- 市面对标分析
- 验收标准
- 演进建议（17 个任务分 4 阶段）

### Common 设计文档

- 设计目标和约束
- 架构组件图
- 数据模型类图
- 4 个核心流程时序图（缓存预热、分布式锁、异步任务、IP 查询）
- 部署架构图
- 5 个缺陷改进方案（含代码示例）
- 2 个架构改进方案
- 接口/数据约定
- 优先级总结和实施路线图
- 测试策略

---

## 四、关键设计要点

### LBS 模块

1. 使用 PostGIS 扩展提供地理空间计算能力
2. 使用 GIST 空间索引提升查询性能
3. 使用 WGS84 坐标系（SRID 4326）
4. 使用 Redis 缓存行政区划数据
5. 使用事务保证网点和围栏创建的原子性
6. 使用分布式锁防止多实例重复初始化数据

### Risk 模块

1. 使用 Redis 存储风控计数器和用户集合
2. 使用 PostgreSQL 存储风控规则和日志
3. 使用异步队列写入风控日志，不阻塞主流程
4. 使用降级机制，Redis 故障时放行订单
5. 支持租户级别和全局级别的风控规则配置
6. 支持风控白名单，跳过风控检测

### Common 模块

1. 使用 @Global() 装饰器全局导出，无需重复导入
2. 使用 Jitter 策略防止缓存雪崩（随机 0-5 分钟偏移）
3. 使用分布式锁保证并发安全（SET NX PX）
4. 使用 Bull 队列异步处理任务，失败重试 3 次
5. 使用 IP 查询缓存，减少第三方 API 调用
6. 支持多级缓存（本地缓存 + Redis）

---

## 五、后续工作

### LBS 模块

1. 实现缺陷改进方案（D-5、D-6、D-9、D-13）
2. 创建 C 端接口（X-1）
3. 集成到订单模块（X-2）
4. 集成到配送模块（X-3）
5. 集成第三方地理编码服务（A-1、A-2）

### Risk 模块

1. 实现规则配置表和服务（D-1、D-2）
2. 实现风控日志持久化（D-3）
3. 创建 Admin 配置接口（X-1）
4. 创建 Admin 日志查询接口（X-2）
5. 集成到订单模块（X-3）
6. 实现风控白名单（D-4）
7. 实现设备指纹检测（D-5）
8. 实现风控降级机制（D-6）

### Common 模块

1. 实现分布式锁优化（D-1）
2. 实现 SCAN 优化（D-2）
3. 实现 IP 查询缓存（D-14）
4. 实现 IP API 配置化（D-13）
5. 实现缓存穿透保护（D-3）
6. 实现缓存击穿保护（D-4）
7. 实现统一监控面板（X-1）
8. 实现多级缓存（A-1）

---

**文档版本**：1.0
**最后更新**：2026-02-22
**维护者**：Backend Team
