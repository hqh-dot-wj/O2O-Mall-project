# ä¼˜æƒ åˆ¸å’Œç§¯åˆ†ç³»ç»Ÿå¿«é€Ÿå¼€å§‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ•°æ®åº“è¿ç§»

```bash
cd apps/backend

# ç”Ÿæˆ Prisma Client
npx prisma generate

# åŒæ­¥æ•°æ®åº“
npx prisma db push
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# ç¡®ä¿ Redis æœåŠ¡å·²å¯åŠ¨ï¼ˆåˆ†å¸ƒå¼é”éœ€è¦ï¼‰
redis-server

# å¯åŠ¨åç«¯æœåŠ¡
npm run start:dev
```

### 3. è®¿é—® API æ–‡æ¡£

æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://localhost:3000/api-docs`

## ğŸ“ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: åˆ›å»ºå¹¶å‘æ”¾ä¼˜æƒ åˆ¸

#### Step 1: åˆ›å»ºä¼˜æƒ åˆ¸æ¨¡æ¿
```http
POST /admin/marketing/coupon/templates
Content-Type: application/json

{
  "name": "æ–°ç”¨æˆ·ä¸“äº«åˆ¸",
  "description": "æ–°ç”¨æˆ·é¦–å•ç«‹å‡10å…ƒ",
  "type": "DISCOUNT",
  "discountAmount": 10,
  "minOrderAmount": 50,
  "totalStock": 1000,
  "limitPerUser": 1,
  "validityType": "FIXED",
  "validDays": 30,
  "status": "ACTIVE"
}
```

#### Step 2: ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸
```http
POST /client/marketing/coupon/claim/:templateId
```

#### Step 3: æŸ¥è¯¢æˆ‘çš„ä¼˜æƒ åˆ¸
```http
GET /client/marketing/coupon/my-coupons?status=UNUSED
```

### åœºæ™¯2: é…ç½®ç§¯åˆ†è§„åˆ™

#### Step 1: é…ç½®ç§¯åˆ†è§„åˆ™
```http
PUT /admin/marketing/points/rules
Content-Type: application/json

{
  "orderPointsEnabled": true,
  "orderPointsRatio": 1,
  "orderPointsBase": 1,
  "signinPointsEnabled": true,
  "signinPointsAmount": 10,
  "pointsRedemptionEnabled": true,
  "pointsRedemptionRatio": 100,
  "pointsRedemptionBase": 1,
  "maxDiscountPercentOrder": 50
}
```

#### Step 2: ç”¨æˆ·ç­¾åˆ°è·å–ç§¯åˆ†
```http
POST /client/marketing/points/signin
```

#### Step 3: æŸ¥è¯¢ç§¯åˆ†ä½™é¢
```http
GET /client/marketing/points/balance
```

### åœºæ™¯3: ä¸‹å•ä½¿ç”¨ä¼˜æƒ åˆ¸å’Œç§¯åˆ†

#### Step 1: è®¡ç®—è®¢å•ä¼˜æƒ 
```http
POST /client/order/calculate-discount
Content-Type: application/json

{
  "items": [
    {
      "productId": "prod_001",
      "productName": "å•†å“A",
      "price": 100,
      "quantity": 2
    }
  ],
  "userCouponId": "coupon_xxx",
  "pointsUsed": 100
}
```

å“åº”ç¤ºä¾‹:
```json
{
  "code": 200,
  "data": {
    "originalAmount": 200,
    "couponDiscount": 10,
    "pointsDiscount": 1,
    "totalDiscount": 11,
    "finalAmount": 189,
    "userCouponId": "coupon_xxx",
    "pointsUsed": 100,
    "couponName": "æ–°ç”¨æˆ·ä¸“äº«åˆ¸"
  }
}
```

#### Step 2: åˆ›å»ºè®¢å•ï¼ˆåœ¨è®¢å•æœåŠ¡ä¸­è°ƒç”¨ï¼‰
```typescript
// åœ¨è®¢å•åˆ›å»ºæ—¶è°ƒç”¨
await orderIntegrationService.handleOrderCreated(
  orderId,
  memberId,
  userCouponId,
  pointsUsed
);
```

#### Step 3: è®¢å•æ”¯ä»˜ï¼ˆåœ¨è®¢å•æœåŠ¡ä¸­è°ƒç”¨ï¼‰
```typescript
// åœ¨è®¢å•æ”¯ä»˜æˆåŠŸæ—¶è°ƒç”¨
await orderIntegrationService.handleOrderPaid(
  orderId,
  memberId,
  payAmount
);
```

## ğŸ”§ ç®¡ç†ç«¯åŠŸèƒ½

### ä¼˜æƒ åˆ¸ç®¡ç†

```http
# æŸ¥è¯¢ä¼˜æƒ åˆ¸æ¨¡æ¿åˆ—è¡¨
GET /admin/marketing/coupon/templates?pageNum=1&pageSize=10

# æŸ¥è¯¢ä¼˜æƒ åˆ¸ä½¿ç”¨ç»Ÿè®¡
GET /admin/marketing/coupon/statistics?templateId=xxx

# å¯¼å‡ºä¼˜æƒ åˆ¸ä½¿ç”¨è®°å½•
GET /admin/marketing/coupon/export?startTime=2024-01-01&endTime=2024-12-31

# æ‰‹åŠ¨å‘æ”¾ä¼˜æƒ åˆ¸
POST /admin/marketing/coupon/distribute/manual
{
  "templateId": "template_xxx",
  "memberIds": ["member_001", "member_002"],
  "remark": "æ´»åŠ¨å¥–åŠ±"
}
```

### ç§¯åˆ†ç®¡ç†

```http
# æŸ¥è¯¢ç§¯åˆ†å‘æ”¾ç»Ÿè®¡
GET /admin/marketing/points/statistics/earn?startTime=2024-01-01

# æŸ¥è¯¢ç§¯åˆ†ä½¿ç”¨ç»Ÿè®¡
GET /admin/marketing/points/statistics/use?startTime=2024-01-01

# æŸ¥è¯¢ç§¯åˆ†ä½™é¢ç»Ÿè®¡
GET /admin/marketing/points/statistics/balance

# æŸ¥è¯¢ç§¯åˆ†æ’è¡Œæ¦œ
GET /admin/marketing/points/ranking?limit=10

# æ‰‹åŠ¨è°ƒæ•´ç”¨æˆ·ç§¯åˆ†
POST /admin/marketing/points/adjust
{
  "memberId": "member_001",
  "amount": 100,
  "type": "EARN_ADMIN",
  "remark": "æ´»åŠ¨å¥–åŠ±"
}

# å¯¼å‡ºç§¯åˆ†æ˜ç»†
GET /admin/marketing/points/export?memberId=member_001
```

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡è§„åˆ™

### ä¼˜æƒ åˆ¸è§„åˆ™

1. **åº“å­˜æ§åˆ¶**
   - ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”é˜²æ­¢è¶…å‘
   - æ”¯æŒå¹¶å‘é¢†å–

2. **é¢†å–é™åˆ¶**
   - æ¯ä¸ªç”¨æˆ·æœ€å¤šé¢†å– N å¼ ï¼ˆç”±æ¨¡æ¿é…ç½®ï¼‰
   - æ€»åº“å­˜é™åˆ¶

3. **ä½¿ç”¨æ¡ä»¶**
   - æœ€ä½æ¶ˆè´¹é‡‘é¢
   - æœ‰æ•ˆæœŸéªŒè¯
   - çŠ¶æ€éªŒè¯

4. **ä¼˜æƒ è®¡ç®—**
   - æ»¡å‡åˆ¸ï¼šç›´æ¥å‡å…å›ºå®šé‡‘é¢
   - æŠ˜æ‰£åˆ¸ï¼šæŒ‰ç™¾åˆ†æ¯”è®¡ç®—ï¼Œä¸è¶…è¿‡æœ€é«˜ä¼˜æƒ 
   - å…‘æ¢åˆ¸ï¼šå…¨é¢æŠµæ‰£

### ç§¯åˆ†è§„åˆ™

1. **è·å–ç§¯åˆ†**
   - æ¶ˆè´¹è·å¾—ï¼šæ¯æ¶ˆè´¹Nå…ƒè·å¾—Mç§¯åˆ†
   - ç­¾åˆ°è·å¾—ï¼šæ¯æ—¥ç­¾åˆ°è·å¾—å›ºå®šç§¯åˆ†
   - ä»»åŠ¡è·å¾—ï¼šå®Œæˆä»»åŠ¡è·å¾—ç§¯åˆ†
   - ç®¡ç†å‘˜è°ƒæ•´ï¼šæ‰‹åŠ¨å¢åŠ ç§¯åˆ†

2. **ä½¿ç”¨ç§¯åˆ†**
   - è®¢å•æŠµæ‰£ï¼šNç§¯åˆ†æŠµæ‰£Må…ƒ
   - æœ€ä½ä½¿ç”¨é™åˆ¶
   - æœ€å¤§æŠµæ‰£æ¯”ä¾‹é™åˆ¶

3. **ç§¯åˆ†æœ‰æ•ˆæœŸ**
   - æ”¯æŒæ°¸ä¹…æœ‰æ•ˆ
   - æ”¯æŒæŒ‡å®šå¤©æ•°åè¿‡æœŸ
   - å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†è¿‡æœŸç§¯åˆ†

4. **å¹¶å‘å®‰å…¨**
   - ä½¿ç”¨ä¹è§‚é”ï¼ˆversionå­—æ®µï¼‰
   - æ”¯æŒé‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰

### è®¢å•é›†æˆè§„åˆ™

1. **ä¼˜æƒ è®¡ç®—é¡ºåº**
   ```
   è®¢å•åŸä»· â†’ ä¼˜æƒ åˆ¸æŠµæ‰£ â†’ ç§¯åˆ†æŠµæ‰£ â†’ æœ€ç»ˆé‡‘é¢
   ```

2. **çŠ¶æ€æµè½¬**
   ```
   è®¢å•åˆ›å»º â†’ é”å®šä¼˜æƒ åˆ¸ + å†»ç»“ç§¯åˆ†
   è®¢å•æ”¯ä»˜ â†’ ä½¿ç”¨ä¼˜æƒ åˆ¸ + æ‰£å‡ç§¯åˆ† + å‘æ”¾æ¶ˆè´¹ç§¯åˆ†
   è®¢å•å–æ¶ˆ â†’ è§£é”ä¼˜æƒ åˆ¸ + è§£å†»ç§¯åˆ†
   è®¢å•é€€æ¬¾ â†’ é€€è¿˜ä¼˜æƒ åˆ¸ + é€€è¿˜ç§¯åˆ† + æ‰£å‡æ¶ˆè´¹ç§¯åˆ†
   ```

## ğŸ” å¸¸è§é—®é¢˜

### Q1: ä¼˜æƒ åˆ¸åº“å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: ç³»ç»Ÿä¼šè¿”å›"ä¼˜æƒ åˆ¸å·²æŠ¢å…‰"çš„é”™è¯¯ï¼Œå»ºè®®å‰ç«¯åšå¥½æç¤ºã€‚

### Q2: ç§¯åˆ†æ‰£å‡å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œå¦‚æœä»ç„¶å¤±è´¥ä¼šè¿”å›é”™è¯¯ã€‚å»ºè®®æ£€æŸ¥ï¼š
- ç”¨æˆ·ç§¯åˆ†ä½™é¢æ˜¯å¦è¶³å¤Ÿ
- æ˜¯å¦å­˜åœ¨å¹¶å‘æ“ä½œ

### Q3: å®šæ—¶ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œæ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- æœåŠ¡å™¨æ—¶åŒºæ˜¯å¦æ­£ç¡®
- `@nestjs/schedule` æ¨¡å—æ˜¯å¦æ­£ç¡®å¯¼å…¥
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ä»»åŠ¡æ˜¯å¦è§¦å‘

### Q4: å¦‚ä½•æµ‹è¯•å¹¶å‘åœºæ™¯ï¼Ÿ
A: å»ºè®®ä½¿ç”¨å‹åŠ›æµ‹è¯•å·¥å…·ï¼ˆå¦‚ Apache JMeterï¼‰æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚ã€‚

### Q5: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Ÿ
A: æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•ï¼ŒåŒ…å«ï¼š
- æ“ä½œç±»å‹
- å…³é”®IDï¼ˆorderId, memberId, couponIdç­‰ï¼‰
- å…³é”®å‚æ•°ï¼ˆamount, pointsç­‰ï¼‰
- æ“ä½œç»“æœ

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

### ä¼˜æƒ åˆ¸æŒ‡æ ‡
- å‘æ”¾æ•°é‡
- ä½¿ç”¨æ•°é‡
- æ ¸é”€ç‡
- åº“å­˜å‰©ä½™
- è¿‡æœŸæ•°é‡

### ç§¯åˆ†æŒ‡æ ‡
- å‘æ”¾æ€»é‡
- ä½¿ç”¨æ€»é‡
- è´¦æˆ·æ€»ä½™é¢
- è¿‡æœŸæ€»é‡
- å†»ç»“æ€»é‡

### æ€§èƒ½æŒ‡æ ‡
- API å“åº”æ—¶é—´
- å¹¶å‘å¤„ç†èƒ½åŠ›
- åˆ†å¸ƒå¼é”è·å–æˆåŠŸç‡
- ä¹è§‚é”å†²çªç‡

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### 1. ä¼˜æƒ åˆ¸é¢†å–å¤±è´¥

**å¯èƒ½åŸå› **:
- åº“å­˜ä¸è¶³
- å·²è¾¾åˆ°é¢†å–ä¸Šé™
- ä¼˜æƒ åˆ¸å·²åœç”¨
- Redis è¿æ¥å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹é”™è¯¯æ¶ˆæ¯
2. æ£€æŸ¥ä¼˜æƒ åˆ¸æ¨¡æ¿çŠ¶æ€
3. æ£€æŸ¥ç”¨æˆ·å·²é¢†å–æ•°é‡
4. æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€

### 2. ç§¯åˆ†æ‰£å‡å¤±è´¥

**å¯èƒ½åŸå› **:
- ç§¯åˆ†ä½™é¢ä¸è¶³
- ä¹è§‚é”å†²çª
- å¹¶å‘æ“ä½œè¿‡å¤š

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†ä½™é¢
2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é‡è¯•æ¬¡æ•°
3. æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡å¹¶å‘è¯·æ±‚

### 3. å®šæ—¶ä»»åŠ¡æœªæ‰§è¡Œ

**å¯èƒ½åŸå› **:
- æœåŠ¡å™¨æ—¶åŒºä¸æ­£ç¡®
- æ¨¡å—æœªæ­£ç¡®å¯¼å…¥
- æœåŠ¡æœªå¯åŠ¨

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æœåŠ¡å™¨æ—¶åŒº: `date`
2. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰å®šæ—¶ä»»åŠ¡è§¦å‘è®°å½•
3. ç¡®è®¤ `ScheduleModule.forRoot()` å·²å¯¼å…¥

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´å®ç°æ–‡æ¡£](./COUPON_AND_POINTS_IMPLEMENTATION.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./coupon-and-points-database-schema.md)
- [å¼€å‘è§„èŒƒ](./QUICK_START.md)

## ğŸ‰ æ€»ç»“

ä¼˜æƒ åˆ¸å’Œç§¯åˆ†ç³»ç»Ÿå·²å®Œæ•´å®ç°ï¼Œæ”¯æŒï¼š
- âœ… å®Œæ•´çš„ä¼˜æƒ åˆ¸ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… çµæ´»çš„ç§¯åˆ†è§„åˆ™é…ç½®
- âœ… å®‰å…¨çš„å¹¶å‘æ§åˆ¶
- âœ… å®Œå–„çš„è®¢å•é›†æˆ
- âœ… è‡ªåŠ¨åŒ–çš„å®šæ—¶ä»»åŠ¡
- âœ… è¯¦ç»†çš„ç»Ÿè®¡åˆ†æ

ç³»ç»Ÿå·²å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼
