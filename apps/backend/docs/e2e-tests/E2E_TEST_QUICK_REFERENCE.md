# 端到端测试快速参考卡

## 🚀 快速执行

```bash
# Windows
cd apps/backend && scripts\test-e2e.bat

# Linux/Mac
cd apps/backend && ./scripts/test-e2e.sh
```

## 📊 测试覆盖

| 场景 | 描述 | 验证点 |
|------|------|--------|
| 1️⃣ 创建活动 | 门店创建课程拼团 | 配置创建、规则正确 |
| 2️⃣ 发起拼团 | C1作为团长发起 | 团长优惠、订单创建 |
| 3️⃣ 用户参团 | C2-C6参团 | 人数统计、拼团成功 |
| 4️⃣ 计算分佣 | 详细分佣计算 | 一级/二级分佣、金额流向 |
| 5️⃣ 拼团失败 | 人数不足场景 | 失败状态、原因记录 |
| 6️⃣ 多团并行 | 第二个拼团 | 多实例、无推荐人 |
| 7️⃣ 查询统计 | 数据统计 | 实例/订单/分佣统计 |
| 8️⃣ 分佣结算 | 7天后结算 | 状态变更、可提现 |

## 💰 关键金额（第一个拼团）

```
订单总收入：¥4,030
├─ 分佣支出：¥442
└─ 门店净利润：¥3,588

注意：平台抽成功能未实现，门店获得100%订单收入
```

## 👥 分佣排行

| 排名 | 用户 | 一级分佣 | 二级分佣 | 总计 |
|------|------|----------|----------|------|
| 🥇 | 张三 | ¥136 (2笔) | ¥102 (3笔) | ¥238 |
| 🥈 | 李四 | ¥136 (2笔) | ¥0 | ¥136 |
| 🥉 | 王五 | ¥68 (1笔) | ¥0 | ¥68 |

## 🔗 推荐关系链

```
张三（团长）
├─ 李四 → 赵六、孙七
├─ 王五 → 周八
└─ 吴九

郑十（无推荐人）
```

## 📈 分佣规则

| 级别 | 比例 | 示例（订单¥680） | 状态 |
|------|------|------------------|------|
| 一级（直推） | 10% | ¥68 | ✅ 已实现 |
| 二级（间推） | 5% | ¥34 | ✅ 已实现 |
| 结算周期 | 7天 | 订单完成后7天 | ✅ 已实现 |
| 平台抽成 | - | - | ❌ 未实现 |

## ✅ 成功标志

```
📊 测试结果统计:
   总场景数: 8
   成功: 8
   失败: 0

💰 金额流向详解：
   订单总收入：¥4030.00
   ├─ 分佣支出：¥442.00
   └─ 门店净利润：¥3588.00

🎉 测试完成！
```

## ⚠️ 常见错误

| 错误 | 原因 | 解决 |
|------|------|------|
| TypeScript 编译错误 | 类型定义缺失 | 已修复：添加 TestUser 接口 |
| 外键约束错误 | 用户不存在 | 已修复：先创建用户 |
| 手机号冲突 | 数据残留 | 已修复：自动清理 |

## 🎯 验证清单

- [ ] 8个场景全部通过
- [ ] 订单总收入 = ¥4,030
- [ ] 分佣总额 = ¥442
- [ ] 门店净利润 = ¥3,588（100%订单收入 - 分佣）
- [ ] 张三分佣 = ¥238
- [ ] 李四分佣 = ¥136
- [ ] 王五分佣 = ¥68
- [ ] 无错误输出

## 📚 相关文档

- [完整测试指南](apps/backend/docs/E2E_TEST_GUIDE.md)
- [测试结果详解](E2E_TEST_RESULTS_SUMMARY.md)
- [业务流程文档](apps/backend/docs/COMPLETE_BUSINESS_FLOW.md)

## ⏱️ 性能基准

- **执行时间**: 5-10秒
- **数据库操作**: ~50次
- **创建记录**: 8用户 + 1配置 + 3实例 + 8订单 + 8分佣

## 🔧 故障排查

```bash
# 1. 检查数据库连接
npx prisma db pull

# 2. 查看测试用户
SELECT * FROM ums_member WHERE member_id LIKE 'user-c%';

# 3. 查看分佣记录
SELECT * FROM fin_commission WHERE tenant_id = '000000';

# 4. 手动清理测试数据
DELETE FROM fin_commission WHERE tenant_id = '000000';
DELETE FROM oms_order WHERE member_id LIKE 'user-c%';
DELETE FROM ums_member WHERE member_id LIKE 'user-c%';
```
