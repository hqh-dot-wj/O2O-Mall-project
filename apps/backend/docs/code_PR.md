# 后端接口与大表专项设计规范（归纳版 · v1.0）

> **适用范围**
> 
> - 所有后端接口开发
> 
> - 所有可能持续增长的数据表
> 
> - 所有新建 / 重构接口
> 
> **目标**  
> 在接口设计阶段就预判：
> 
> - 数据规模
> 
> - 访问频率（QPS）
> 
> - 性能瓶颈
> 
> - 未来 1～3 年的技术升级路径

---

## 一、总原则（写在规范首页的）

> **接口设计不仅要“功能正确”，还必须对“数据增长 + 访问增长”负责。**

任何接口，在开发和 PR 阶段，**都必须回答三个问题**：

`1. 这个接口会不会高频访问（QPS）？ 2. 这个接口会不会访问大表？ 3. 当数据量和 QPS 翻 10 倍时，系统是否仍然可控？`

---

## 二、接口是否必须考虑 QPS？——明确答案

### 结论（Hard）

`是的，所有接口在设计时都必须评估 QPS 等级`

即使你现在是：

- 内部系统

- 新项目

- 用户不多

也必须**显式声明**：  
👉「为什么当前可以不做性能升级」

---

## 三、接口 QPS 分级规范（强制使用）

### 1️⃣ 接口访问频率分级

| 等级  | QPS      | 典型接口    |
| --- | -------- | ------- |
| Q1  | < 1      | 后台管理、配置 |
| Q2  | 1 ~ 20   | 普通业务接口  |
| Q3  | 20 ~ 200 | 列表页、详情页 |
| Q4  | > 200    | 首页、核心链路 |

---

### 2️⃣ 不同 QPS 等级的强制设计要求

#### ✅ Q1（< 1 QPS）

- 可接受简单查询

- 可接受轻度 JOIN

- 不强制缓存

---

#### ⚠️ Q2（1 ~ 20 QPS）

**必须**

- 查询命中索引

- 返回数据量受控

- 禁止 N+1

---

#### ⛔ Q3（20 ~ 200 QPS）

**强制要求**

- 查询 explain 可控

- 避免复杂 JOIN

- 必须评估缓存可行性

- 禁止深分页

---

#### 🚨 Q4（> 200 QPS）

**架构级要求**

- 必须使用缓存 / 读模型

- 必须支持水平扩展

- 写操作不得阻塞主流程

---

## 四、大表专项设计规范（核心部分）

### 3️⃣ 什么表必须默认按「大表」设计？

**以下表类型，一律按“大表”处理（Hard）：**

- 订单表

- 各类流水表（支付 / 钱包 / 积分）

- 行为日志 / 操作日志

- 明细表（订单项、参与记录）

- 历史记录表

- 消息 / 通知表

> ❗ **禁止在设计时假设这些表“数据量不大”**

---

### 4️⃣ 数据量级分段标准（统一口径）

| 级别  | 数据量            |
| --- | -------------- |
| D1  | < 10 万         |
| D2  | 10 万 ~ 100 万   |
| D3  | 100 万 ~ 1000 万 |
| D4  | > 1000 万       |

---

### 5️⃣ 数据量级 → 技术方案强制映射表

#### ✅ D1（< 10 万）

- 单表

- 普通索引

- offset 分页可接受

---

#### ⚠️ D2（10 万 ~ 100 万）

**必须**

- where / order by 有索引

- 禁止全表扫描

- 限制返回字段

---

#### ⛔ D3（100 万 ~ 1000 万）

**强制升级**

- 禁止 offset 深分页（> 5000）

- 使用：
  
  - 游标分页
  
  - 时间范围分页

- JOIN 极度克制

- explain 必须可审计

---

#### 🚨 D4（> 1000 万）

**架构级调整（必须）**

- 分表 / 分区

- 读写模型分离（CQRS）

- 搜索型查询迁移到 ES

- 历史数据归档

---

## 五、接口查询设计强约束（结合前面规范）

### 6️⃣ 查询禁止项（Hard）

`❌ offset > 5000 ❌ order by 非索引字段 ❌ 无条件分页 ❌ 大表 like %xxx%`

---

### 7️⃣ 返回数据量限制

`- 单接口返回 ≤ 1000 条 - 超出必须分页或异步导出`

---

## 六、典型大表的专项设计规则

### 8️⃣ 流水表（支付 / 钱包 / 积分）

**强制规则**

- 只允许 insert

- 禁止 update

- 禁止 delete

- 查询必须带时间范围

**升级路径**

- 按月 / 按年分表

- 历史表归档

- 统计查询走聚合表

---

### 9️⃣ 订单表

**设计要求**

- 状态字段冗余（避免 JOIN）

- 查询条件受控（白名单）

- 写操作短事务

**升级路径**

- 按时间 / 商户分表

- 订单读模型

- 缓存热点订单

---

## 七、接口性能设计 PR 必答项（最终落地）

> **任何涉及新接口 / 新查询的 PR，必须回答以下问题：**

`### 性能与数据规模评估  - 接口 QPS 预期等级（Q1 / Q2 / Q3 / Q4）： - 是否访问天然大表？（是 / 否） - 当前 & 1年 & 3年数据量预估： - 是否命中索引？ - 是否存在深分页 / 全表扫描？ - 数据或 QPS 翻 10 倍后，是否有升级方案？`

---

## 八、技术升级强制触发条件（红线）

`出现以下任一情况，必须启动技术升级设计： - 单表数据量 > 500 万 - 接口 QPS > 200 - P95 响应时间 > 500ms - explain 出现全表扫描 - offset 分页 > 5000`

---

## 九、和你之前规范的统一总结（一句话版）

> **接口规范解决“怎么写不会乱”，  
> 大表规范解决“数据长大后不会炸”。**
