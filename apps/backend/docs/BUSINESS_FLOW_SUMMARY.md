# ä¸šåŠ¡æµç¨‹æ€»ç»“

## ğŸ¯ å¿«é€Ÿç†è§£

ä½ çš„ç³»ç»Ÿ**å·²ç»æœ‰å®Œæ•´çš„è´¢åŠ¡æ¨¡å—**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… è®¢å•ç®¡ç†
- âœ… æ”¯ä»˜å¤„ç†
- âœ… åˆ†ä½£è®¡ç®—
- âœ… é’±åŒ…ç®¡ç†
- âœ… æç°å¤„ç†

## ğŸ“Š å®Œæ•´æµç¨‹ï¼ˆ6ä¸ªé˜¶æ®µï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: ä¸‹å• (Order Creation)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·é€‰æ‹©å•†å“ â†’ åŠ å…¥è´­ç‰©è½¦ â†’ ç»“ç®— â†’ åˆ›å»ºè®¢å•                â”‚
â”‚  çŠ¶æ€: PENDING_PAY                                           â”‚
â”‚  æ–‡ä»¶: apps/backend/src/module/client/order/order.service.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: æ”¯ä»˜ (Payment)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¢„ä¸‹å• â†’ è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ â†’ ç”¨æˆ·æ”¯ä»˜ â†’ æ”¯ä»˜å›è°ƒ                â”‚
â”‚  çŠ¶æ€: PENDING_PAY â†’ PAID                                    â”‚
â”‚  æ–‡ä»¶: apps/backend/src/module/client/payment/payment.service.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3: åˆ†ä½£è®¡ç®— (Commission Calculation) â­                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ”¯ä»˜æˆåŠŸ â†’ å¼‚æ­¥é˜Ÿåˆ— â†’ è®¡ç®—åˆ†ä½£ â†’ åˆ›å»ºå†»ç»“è®°å½•              â”‚
â”‚  - L1ï¼ˆç›´æ¨ï¼‰ï¼š10%                                           â”‚
â”‚  - L2ï¼ˆé—´æ¨ï¼‰ï¼š5%                                            â”‚
â”‚  çŠ¶æ€: FROZEN                                                â”‚
â”‚  æ–‡ä»¶: apps/backend/src/module/finance/commission/commission.service.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ4: è®¢å•å®Œæˆ (Order Completion)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®ç‰©ï¼šç¡®è®¤æ”¶è´§ â†’ æ›´æ–°ç»“ç®—æ—¶é—´ï¼ˆT+7å¤©ï¼‰                     â”‚
â”‚  æœåŠ¡ï¼šæŠ€å¸ˆæ ¸é”€ â†’ æ›´æ–°ç»“ç®—æ—¶é—´ï¼ˆT+1å¤©ï¼‰                     â”‚
â”‚  çŠ¶æ€: PAID â†’ COMPLETED                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ5: åˆ†ä½£ç»“ç®— (Commission Settlement) â­                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®šæ—¶ä»»åŠ¡æ‰«æ â†’ åˆ°æœŸä½£é‡‘ â†’ è§£å†»å…¥è´¦ â†’ å¢åŠ é’±åŒ…ä½™é¢          â”‚
â”‚  çŠ¶æ€: FROZEN â†’ SETTLED                                      â”‚
â”‚  æ–‡ä»¶: apps/backend/src/module/finance/settlement/settlement.scheduler.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ6: æç° (Withdrawal)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”³è¯·æç° â†’ å†»ç»“ä½™é¢ â†’ å®¡æ ¸ â†’ æ‰“æ¬¾ â†’ æ‰£é™¤ä½™é¢               â”‚
â”‚  çŠ¶æ€: PENDING â†’ APPROVED â†’ SUCCESS                          â”‚
â”‚  æ–‡ä»¶: apps/backend/src/module/finance/withdrawal/withdrawal.service.tsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° é‡‘é¢æµå‘ç¤ºä¾‹

### è®¢å•ï¼šÂ¥680

```
ç”¨æˆ·æ”¯ä»˜ Â¥680
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æ”¶å…¥ Â¥680                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ å¹³å°æŠ½æˆï¼ˆ0%ï¼‰ï¼šÂ¥0                  â”‚  â†’ å½“å‰æœªå®ç°
â”‚  â””â”€ é—¨åº—æ”¶å…¥ï¼ˆ100%ï¼‰ï¼šÂ¥680             â”‚  â†’ é—¨åº—è´¦æˆ·
â”‚     â”œâ”€ åˆ†ä½£æ”¯å‡ºï¼šÂ¥102                   â”‚
â”‚     â”‚  â”œâ”€ L1ï¼ˆæå››ï¼‰ï¼šÂ¥68 (10%)        â”‚  â†’ æå››é’±åŒ…
â”‚     â”‚  â””â”€ L2ï¼ˆå¼ ä¸‰ï¼‰ï¼šÂ¥34 (5%)         â”‚  â†’ å¼ ä¸‰é’±åŒ…
â”‚     â””â”€ é—¨åº—å‡€åˆ©æ¶¦ï¼šÂ¥578                â”‚  â†’ é—¨åº—æœ€ç»ˆæ”¶å…¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—‚ï¸ æ ¸å¿ƒæ•°æ®è¡¨

| è¡¨å | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|----------|
| `oms_order` | è®¢å•è¡¨ | orderSn, status, payAmount, shareUserId, referrerId |
| `fin_commission` | åˆ†ä½£è®°å½• | orderId, beneficiaryId, level, amount, status |
| `fin_wallet` | é’±åŒ…è¡¨ | memberId, balance, frozenBalance |
| `fin_transaction` | æµæ°´è¡¨ | walletId, type, amount, balanceAfter |
| `fin_withdrawal` | æç°è¡¨ | memberId, amount, status |
| `sys_dist_config` | åˆ†é”€é…ç½® | tenantId, level1Rate, level2Rate |

## â° æ—¶é—´çº¿

| æ—¶é—´ | äº‹ä»¶ | è¯´æ˜ |
|------|------|------|
| T+0 | ä¸‹å• | åˆ›å»ºè®¢å• |
| T+0 | æ”¯ä»˜ | è§¦å‘åˆ†ä½£è®¡ç®— |
| T+0 | åˆ†ä½£è®¡ç®— | åˆ›å»ºå†»ç»“è®°å½• |
| T+1 (æœåŠ¡) | åˆå§‹ç»“ç®— | æœåŠ¡ç±»è®¢å• |
| T+14 (å®ç‰©) | åˆå§‹ç»“ç®— | å®ç‰©è®¢å• |
| T+æ ¸é”€/æ”¶è´§ | æ›´æ–°ç»“ç®— | æœåŠ¡T+1ï¼Œå®ç‰©T+7 |
| T+ç»“ç®—æ—¶é—´ | åˆ†ä½£ç»“ç®— | è§£å†»å…¥è´¦ |

## ğŸ” å½“å‰ç³»ç»ŸçŠ¶æ€

### âœ… å·²å®ç°

1. **è®¢å•æ¨¡å—** - å®Œæ•´çš„ä¸‹å•ã€æ”¯ä»˜ã€å–æ¶ˆæµç¨‹
2. **åˆ†ä½£è®¡ç®—** - è‡ªåŠ¨è®¡ç®—ä¸€çº§ã€äºŒçº§åˆ†ä½£
3. **é’±åŒ…ç®¡ç†** - ä½™é¢ã€å†»ç»“ä½™é¢ã€æµæ°´è®°å½•
4. **æç°å¤„ç†** - ç”³è¯·ã€å®¡æ ¸ã€æ‰“æ¬¾æµç¨‹
5. **å®šæ—¶ç»“ç®—** - è‡ªåŠ¨æ‰«æå¹¶ç»“ç®—åˆ°æœŸä½£é‡‘
6. **å¼‚æ­¥å¤„ç†** - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è®¡ç®—åˆ†ä½£
7. **å¹¶å‘æ§åˆ¶** - ä¹è§‚é”ã€æ‚²è§‚é”é˜²æ­¢å¹¶å‘é—®é¢˜
8. **å®‰å…¨æœºåˆ¶** - è‡ªè´­æ£€æµ‹ã€é»‘åå•ã€å¾ªç¯æ¨èæ£€æµ‹

### âŒ æœªå®ç°ï¼ˆæµ‹è¯•è„šæœ¬ä¸­æ¨¡æ‹Ÿçš„ï¼‰

1. **å¹³å°æŠ½æˆ** - æµ‹è¯•ä¸­çš„10%å¹³å°æŠ½æˆåªæ˜¯æ¼”ç¤º
   - æ•°æ®åº“è¡¨ï¼šéœ€è¦æ·»åŠ  `fin_platform_income`
   - è®¢å•å­—æ®µï¼šéœ€è¦æ·»åŠ  `platformCommission`, `storeRevenue`
   - é…ç½®å­—æ®µï¼šéœ€è¦åœ¨ `sys_tenant` æ·»åŠ  `commissionRate`

2. **å¹³å°æ”¶å…¥ç»Ÿè®¡** - è¶…çº§ç®¡ç†å‘˜æŸ¥çœ‹å¹³å°æ€»æ”¶å…¥

## ğŸ“ å…³é”®ä»£ç ä½ç½®

### è®¢å•æµç¨‹
```
apps/backend/src/module/client/order/
â”œâ”€â”€ order.service.ts              # è®¢å•æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ order.repository.ts           # è®¢å•æ•°æ®è®¿é—®
â””â”€â”€ services/
    â”œâ”€â”€ order-checkout.service.ts # ç»“ç®—é¢„è§ˆ
    â””â”€â”€ attribution.service.ts    # å½’å› å¤„ç†
```

### æ”¯ä»˜æµç¨‹
```
apps/backend/src/module/client/payment/
â”œâ”€â”€ payment.service.ts            # æ”¯ä»˜æ ¸å¿ƒé€»è¾‘
â””â”€â”€ payment.controller.ts         # æ”¯ä»˜æ¥å£
```

### è´¢åŠ¡æµç¨‹
```
apps/backend/src/module/finance/
â”œâ”€â”€ commission/
â”‚   â”œâ”€â”€ commission.service.ts     # åˆ†ä½£è®¡ç®— â­
â”‚   â”œâ”€â”€ commission.processor.ts   # å¼‚æ­¥å¤„ç†
â”‚   â””â”€â”€ commission.repository.ts  # æ•°æ®è®¿é—®
â”œâ”€â”€ settlement/
â”‚   â””â”€â”€ settlement.scheduler.ts   # å®šæ—¶ç»“ç®— â­
â”œâ”€â”€ wallet/
â”‚   â”œâ”€â”€ wallet.service.ts         # é’±åŒ…æ“ä½œ â­
â”‚   â””â”€â”€ transaction.repository.ts # æµæ°´è®°å½•
â””â”€â”€ withdrawal/
    â”œâ”€â”€ withdrawal.service.ts     # æç°å¤„ç† â­
    â””â”€â”€ withdrawal-audit.service.ts # å®¡æ ¸é€»è¾‘
```

## ğŸ¯ æµ‹è¯•è„šæœ¬ vs å®é™…ç³»ç»Ÿ

### æµ‹è¯•è„šæœ¬åšäº†ä»€ä¹ˆï¼Ÿ

æµ‹è¯•è„šæœ¬ï¼ˆ`apps/backend/test/e2e-marketing-flow.test.ts`ï¼‰**æ¨¡æ‹Ÿäº†å®Œæ•´æµç¨‹**ï¼š

1. âœ… åˆ›å»ºè¥é”€é…ç½®
2. âœ… åˆ›å»ºè®¢å•
3. âœ… æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
4. âœ… **æ‰‹åŠ¨è®¡ç®—åˆ†ä½£**ï¼ˆå®é™…ç³»ç»Ÿæ˜¯è‡ªåŠ¨çš„ï¼‰
5. âœ… **æ‰‹åŠ¨åˆ›å»ºåˆ†ä½£è®°å½•**ï¼ˆå®é™…ç³»ç»Ÿæ˜¯è‡ªåŠ¨çš„ï¼‰
6. âœ… **æ‰‹åŠ¨ç»“ç®—åˆ†ä½£**ï¼ˆå®é™…ç³»ç»Ÿæ˜¯å®šæ—¶ä»»åŠ¡ï¼‰

### å®é™…ç³»ç»Ÿå¦‚ä½•å·¥ä½œï¼Ÿ

åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œ**ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œ**ï¼š

1. ç”¨æˆ·ä¸‹å• â†’ è‡ªåŠ¨åˆ›å»ºè®¢å•
2. ç”¨æˆ·æ”¯ä»˜ â†’ è‡ªåŠ¨è§¦å‘åˆ†ä½£è®¡ç®—ï¼ˆå¼‚æ­¥é˜Ÿåˆ—ï¼‰
3. åˆ†ä½£è®¡ç®— â†’ è‡ªåŠ¨åˆ›å»ºå†»ç»“è®°å½•
4. å®šæ—¶ä»»åŠ¡ â†’ è‡ªåŠ¨æ‰«æå¹¶ç»“ç®—åˆ°æœŸä½£é‡‘
5. ç”¨æˆ·æç° â†’ å®¡æ ¸åè‡ªåŠ¨æ‰“æ¬¾

## ğŸš€ å¦‚ä½•å¯ç”¨å¹³å°æŠ½æˆï¼Ÿ

å¦‚æœä½ æƒ³å®ç°æµ‹è¯•è„šæœ¬ä¸­çš„"å¹³å°æŠ½æˆ"åŠŸèƒ½ï¼Œéœ€è¦ï¼š

### 1. ä¿®æ”¹æ•°æ®åº“

```prisma
// åœ¨ sys_tenant è¡¨æ·»åŠ 
model SysTenant {
  // ... ç°æœ‰å­—æ®µ
  commissionRate  Decimal @default(0.00) @map("commission_rate") @db.Decimal(5, 2)
  commissionMode  String  @default("NONE") @map("commission_mode")
}

// åœ¨ oms_order è¡¨æ·»åŠ 
model OmsOrder {
  // ... ç°æœ‰å­—æ®µ
  platformCommission Decimal @default(0) @map("platform_commission") @db.Decimal(10, 2)
  storeRevenue       Decimal @map("store_revenue") @db.Decimal(10, 2)
}

// æ–°å¢å¹³å°æ”¶å…¥è¡¨
model FinPlatformIncome {
  id          BigInt   @id @default(autoincrement())
  orderId     String   @map("order_id")
  tenantId    String   @map("tenant_id")
  orderAmount Decimal  @db.Decimal(10, 2)
  rate        Decimal  @db.Decimal(5, 2)
  amount      Decimal  @db.Decimal(10, 2)
  status      String   @default("PENDING")
  settleTime  DateTime? @map("settle_time")
  createTime  DateTime @default(now()) @map("create_time")
  
  @@map("fin_platform_income")
}
```

### 2. ä¿®æ”¹è®¢å•åˆ›å»ºé€»è¾‘

```typescript
// åœ¨ order.service.ts çš„ createOrder æ–¹æ³•ä¸­
const tenant = await this.prisma.sysTenant.findUnique({
  where: { tenantId: dto.tenantId }
});

const commissionRate = Number(tenant.commissionRate) / 100;
const platformCommission = preview.payAmount * commissionRate;
const storeRevenue = preview.payAmount - platformCommission;

const order = await this.prisma.omsOrder.create({
  data: {
    // ... å…¶ä»–å­—æ®µ
    platformCommission,
    storeRevenue,
  }
});

// å¦‚æœæœ‰æŠ½æˆï¼Œåˆ›å»ºå¹³å°æ”¶å…¥è®°å½•
if (platformCommission > 0) {
  await this.prisma.finPlatformIncome.create({
    data: {
      orderId: order.id,
      tenantId: dto.tenantId,
      orderAmount: preview.payAmount,
      rate: tenant.commissionRate,
      amount: platformCommission,
      status: 'PENDING',
    }
  });
}
```

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- [å®Œæ•´ä¸šåŠ¡æµç¨‹æ–‡æ¡£](./apps/backend/docs/COMPLETE_BUSINESS_FLOW.md) - è¯¦ç»†çš„æµç¨‹è¯´æ˜
- [å¹³å°æŠ½æˆæŒ‡å—](./apps/backend/docs/PLATFORM_COMMISSION_GUIDE.md) - å¹³å°æŠ½æˆå®ç°æ–¹æ¡ˆ
- [ç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—](./apps/backend/docs/E2E_TEST_GUIDE.md) - æµ‹è¯•è„šæœ¬è¯´æ˜
- [è´¢åŠ¡æ¨¡å—æ–‡æ¡£](./apps/backend/src/module/finance/finance.md) - è´¢åŠ¡æ¨¡å—æŠ€æœ¯æ–‡æ¡£

## ğŸ‰ æ€»ç»“

ä½ çš„ç³»ç»Ÿ**å·²ç»æœ‰å®Œæ•´çš„è´¢åŠ¡æµç¨‹**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… è®¢å• â†’ æ”¯ä»˜ â†’ åˆ†ä½£ â†’ ç»“ç®— â†’ æç°
- âœ… å¼‚æ­¥å¤„ç†ã€å¹¶å‘æ§åˆ¶ã€å®‰å…¨æœºåˆ¶
- âœ… å®Œæ•´çš„æ•°æ®æµè½¬å’ŒçŠ¶æ€ç®¡ç†

æµ‹è¯•è„šæœ¬ä¸­çš„"å¹³å°æŠ½æˆ"åªæ˜¯**æ¼”ç¤ºåŠŸèƒ½**ï¼Œå®é™…ç³»ç»Ÿä¸­ï¼š
- å½“å‰ï¼šé—¨åº—è·å¾—100%è®¢å•æ”¶å…¥ï¼ˆæ‰£é™¤åˆ†ä½£ï¼‰
- å¦‚éœ€å¯ç”¨ï¼šæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ä¿®æ”¹å³å¯

æ‰€æœ‰ä»£ç éƒ½åœ¨ `apps/backend/src/module/` ç›®å½•ä¸‹ï¼Œç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ï¼
