# 营销活动端到端测试指南（增强版）

## 概述

这是一个完整的端到端测试脚本，模拟从门店创建营销活动到用户参与、订单生成、详细分佣计算、分佣结算的全流程。

## 新增特性

✨ **详细的金额统计**
- 订单总收入
- 平台抽成（10%）
- 门店毛收入
- 分佣支出明细
- 门店净利润

✨ **完整的分佣体系**
- 一级分佣（直推）：10%
- 二级分佣（间推）：5%
- 按受益人汇总
- 分佣状态跟踪（待结算/已结算）

✨ **多种测试场景**
- 成功拼团（6人）
- 失败拼团（人数不足）
- 多团并行
- 有推荐人 vs 无推荐人
- 分佣结算模拟

## 测试场景

### 场景 1: 门店创建课程拼团活动
- 创建一个课程拼团营销配置
- 商品：声乐课（course-vocal-001）
- 规则：
  - 拼团价：¥680/人
  - 最低人数：6 人
  - 最多人数：8 人
  - 团长优惠：¥50
  - 总课时：8 节课
  - 上课地址：北京市朝阳区音乐培训中心

### 场景 2: 用户 C1 发起拼团（团长）
- C1（张三）作为团长发起拼团
- 支付金额：¥630（¥680 - ¥50 团长优惠）
- 创建订单并关联到营销实例
- 当前拼团进度：1/6
- **无推荐人，不产生分佣**

### 场景 3: 用户 C2-C6 参团
- C2（李四）参团：¥680，C1推荐 → C1获得一级分佣¥68
- C3（王五）参团：¥680，C1推荐 → C1获得一级分佣¥68
- C4（赵六）参团：¥680，C2推荐 → C2获得一级分佣¥68，C1获得二级分佣¥34
- C5（孙七）参团：¥680，C2推荐 → C2获得一级分佣¥68，C1获得二级分佣¥34
- C6（周八）参团：¥680，C3推荐 → C3获得一级分佣¥68，C1获得二级分佣¥34
- 当达到 6 人时，拼团成功
- 实例状态更新为 SUCCESS

### 场景 4: 计算分佣（详细版）
**订单总收入：¥4,030**
- C1订单：¥630（团长优惠）
- C2-C6订单：¥680 × 5 = ¥3,400

**收入分配：**
- 平台抽成（10%）：¥403
- 门店毛收入（90%）：¥3,627
- 分佣支出：¥442
  - C1一级分佣：¥68 × 3 = ¥204（推荐C2、C3、C7）
  - C1二级分佣：¥34 × 3 = ¥102（C2推荐C4、C5，C3推荐C6）
  - C2一级分佣：¥68 × 2 = ¥136（推荐C4、C5）
  - C3一级分佣：¥68 × 1 = ¥68（推荐C6）
- 门店净利润：¥3,185

**分佣排行榜：**
1. C1（张三）：¥306（一级¥204 + 二级¥102）
2. C2（李四）：¥136（一级¥136）
3. C3（王五）：¥68（一级¥68）

**分佣状态：** 全部为"待结算"（7天后可提现）

### 场景 5: 拼团失败（人数不足）
- C4 发起新的拼团
- 只有 C5 参团（共 2 人）
- 超时后拼团失败
- 实例状态更新为 FAILED

### 场景 6: 第二个成功拼团（测试多团并行）
- C7（吴九）作为团长发起新团：¥630，C1推荐 → C1获得一级分佣¥63
- C8（郑十）参团：¥680，**无推荐人，不产生分佣**
- 当前进度：2/6（未达到最低人数）

### 场景 7: 查询统计数据
- 统计营销实例状态分布
  - SUCCESS: 1个
  - FAILED: 1个
  - ACTIVE: 1个
- 统计订单支付状态和金额
  - PAID: 8笔，总额¥5,340
- 统计分佣记录
  - FROZEN: 10条，总额¥505

### 场景 8: 模拟分佣结算（7天后）
- 将所有"待结算"分佣更新为"已结算"
- 用户可提现金额：
  - C1（张三）：¥369（一级¥267 + 二级¥102）
  - C2（李四）：¥136（一级¥136）
  - C3（王五）：¥68（一级¥68）

## 执行方式

### 方式 1: 使用便捷脚本（推荐）

**Windows:**
```bash
cd apps/backend
scripts\test-e2e.bat
```

**Linux/Mac:**
```bash
cd apps/backend
chmod +x scripts/test-e2e.sh
./scripts/test-e2e.sh
```

### 方式 2: 直接运行

```bash
cd apps/backend
npx ts-node test/e2e-marketing-flow.test.ts
```

## 测试数据

### 租户信息
- 租户 ID: `000000`

### 测试商品
- 商品 ID: `course-vocal-001`（少儿声乐启蒙课）
- SKU ID: `course-vocal-001-68`（小班 6-8 人）

### 测试用户及推荐关系

| 用户 | ID | 姓名 | 手机号 | 推荐人 | 角色 |
|------|-----|------|--------|--------|------|
| C1 | user-c1 | 张三 | 13800000001 | 无 | 第一团团长 |
| C2 | user-c2 | 李四 | 13800000002 | C1 | 参团者 |
| C3 | user-c3 | 王五 | 13800000003 | C1 | 参团者 |
| C4 | user-c4 | 赵六 | 13800000004 | C2 | 参团者（C1的二级） |
| C5 | user-c5 | 孙七 | 13800000005 | C2 | 参团者（C1的二级） |
| C6 | user-c6 | 周八 | 13800000006 | C3 | 参团者（C1的二级） |
| C7 | user-c7 | 吴九 | 13800000007 | C1 | 第二团团长 |
| C8 | user-c8 | 郑十 | 13800000008 | 无 | 参团者 |

### 推荐关系图

```
C1（张三）
├─ C2（李四）
│  ├─ C4（赵六）
│  └─ C5（孙七）
├─ C3（王五）
│  └─ C6（周八）
└─ C7（吴九）

C8（郑十）- 无推荐人
```

## 输出示例

```
🚀 营销活动端到端测试开始（增强版）
================================================================================
测试租户: 000000
测试商品: course-vocal-001
测试用户: 8 个
分佣规则: 一级10% | 二级5% | 平台10%
================================================================================

================================================================================
📍 清理测试数据
================================================================================
✅ 测试数据清理完成

================================================================================
📍 场景 1: 门店创建课程拼团活动
================================================================================
✅ 课程拼团活动创建成功
{
  "configId": "clxxx...",
  "templateCode": "COURSE_GROUP_BUY",
  "rules": {
    "price": 680,
    "minCount": 6,
    "maxCount": 8,
    "leaderDiscount": 50,
    ...
  }
}

================================================================================
📍 场景 2: 用户 C1 发起拼团（团长）
================================================================================
✅ C1 发起拼团成功
{
  "instanceId": "clxxx...",
  "orderId": "clxxx...",
  "orderSn": "ORD1234567890C1",
  "amount": 630,
  "leaderDiscount": 50
}

================================================================================
📍 场景 3: 用户 C2-C6 参团
================================================================================
✅ 李四 参团成功
{
  "orderId": "clxxx...",
  "orderSn": "ORD1234567891C2",
  "amount": 680,
  "currentCount": 2
}
...
ℹ️  🎉 拼团成功！当前人数: 6/6

================================================================================
📍 场景 4: 计算分佣（详细版）
================================================================================
ℹ️  找到 6 个已支付订单
ℹ️  创建分佣配置
{
  "level1Rate": "10%",
  "level2Rate": "5%"
}
✅ 分佣计算完成
{
  "summary": {
    "totalRevenue": "4030.00",
    "platformCommission": "403.00",
    "platformRate": "10%",
    "storeGrossRevenue": "3627.00",
    "totalDistCommission": "442.00",
    "storeNetRevenue": "3185.00",
    "orderCount": 6,
    "commissionRecordCount": 10
  },
  "distConfig": {
    "level1Rate": "10%",
    "level2Rate": "5%",
    "settlementPeriod": "7天"
  },
  "orderDetails": [...],
  "beneficiarySummary": [
    {
      "beneficiaryName": "张三",
      "level1": { "count": 3, "amount": "¥204.00" },
      "level2": { "count": 3, "amount": "¥102.00" },
      "totalAmount": "¥306.00",
      "status": "待结算（7天后可提现）"
    },
    {
      "beneficiaryName": "李四",
      "level1": { "count": 2, "amount": "¥136.00" },
      "level2": { "count": 0, "amount": "¥0.00" },
      "totalAmount": "¥136.00",
      "status": "待结算（7天后可提现）"
    },
    {
      "beneficiaryName": "王五",
      "level1": { "count": 1, "amount": "¥68.00" },
      "level2": { "count": 0, "amount": "¥0.00" },
      "totalAmount": "¥68.00",
      "status": "待结算（7天后可提现）"
    }
  ]
}

💰 金额流向详解：
   订单总收入：¥4030.00
   ├─ 平台抽成（10%）：¥403.00
   └─ 门店收入（90%）：¥3627.00
      ├─ 分佣支出：¥442.00
      └─ 门店净利润：¥3185.00

================================================================================
📍 场景 5: 拼团失败（人数不足）
================================================================================
✅ 拼团失败场景模拟完成
{
  "instanceId": "clxxx...",
  "currentCount": 2,
  "targetCount": 6,
  "status": "FAILED",
  "reason": "人数不足"
}

================================================================================
📍 场景 6: 第二个拼团（测试多团并行）
================================================================================
✅ C7（吴九）发起第二个拼团
{
  "instanceId": "clxxx...",
  "orderId": "clxxx...",
  "amount": 630
}
✅ C8（郑十）参团，无推荐人
{
  "orderId": "clxxx...",
  "amount": 680,
  "currentCount": 2,
  "note": "此订单不产生分佣"
}
ℹ️  第二个拼团创建完成（2/6人），未达到最低人数

================================================================================
📍 场景 7: 查询统计数据
================================================================================
✅ 统计数据查询完成
{
  "instanceStats": [
    { "status": "SUCCESS", "count": 1 },
    { "status": "FAILED", "count": 1 },
    { "status": "ACTIVE", "count": 1 }
  ],
  "orderStats": [
    { "payStatus": "PAID", "count": 8, "totalAmount": "¥5340.00" }
  ],
  "commissionStats": [
    { "status": "FROZEN", "count": 10, "totalAmount": "¥505.00" }
  ]
}

================================================================================
📍 场景 8: 模拟分佣结算（7天后）
================================================================================
ℹ️  找到 10 条待结算分佣记录
✅ 分佣结算完成
{
  "settleTime": "2026-02-15T10:00:00.000Z",
  "settledCount": 10,
  "totalSettledAmount": "505.00",
  "beneficiarySummary": [
    { "beneficiaryName": "张三", "totalAmount": "¥369.00", "status": "已结算，可提现" },
    { "beneficiaryName": "李四", "totalAmount": "¥136.00", "status": "已结算，可提现" },
    { "beneficiaryName": "王五", "totalAmount": "¥68.00", "status": "已结算，可提现" }
  ]
}

💸 可提现金额汇总：
   张三: ¥369.00
   李四: ¥136.00
   王五: ¥68.00

================================================================================
📍 测试结果汇总
================================================================================

📊 测试结果统计:
   总场景数: 8
   成功: 8
   失败: 0

💼 关键业务指标:

   📈 收入分析:
      订单总收入: 5340.00
      平台抽成: 534.00 (10%)
      门店毛收入: 4806.00
      分佣支出: 505.00
      门店净利润: 4301.00

   👥 分佣排行榜:
      1. 张三: ¥369.00
         └─ 一级: 4笔 ¥267.00 | 二级: 3笔 ¥102.00
      2. 李四: ¥136.00
         └─ 一级: 2笔 ¥136.00 | 二级: 0笔 ¥0.00
      3. 王五: ¥68.00
         └─ 一级: 1笔 ¥68.00 | 二级: 0笔 ¥0.00

   💸 结算统计:
      已结算笔数: 10
      已结算总额: ¥505.00

================================================================================
🎉 测试完成！
================================================================================
```

## 验证要点

### 1. 营销配置创建
- ✅ 配置成功创建
- ✅ 规则参数正确
- ✅ 状态为 ON_SHELF

### 2. 拼团流程
- ✅ 团长创建实例成功
- ✅ 团长享受优惠（¥630 vs ¥680）
- ✅ 参团者正常支付（¥680）
- ✅ 人数统计正确
- ✅ 达到最低人数时状态更新为 SUCCESS
- ✅ 多团并行正常工作

### 3. 订单生成
- ✅ 每个用户生成独立订单
- ✅ 订单金额正确
- ✅ 订单状态为 COMPLETED
- ✅ 支付状态为 PAID
- ✅ 订单明细包含商品信息
- ✅ 推荐人信息正确记录

### 4. 分佣计算（详细版）
- ✅ 统计所有已支付订单
- ✅ 总收入计算正确
- ✅ 平台抽成 10%
- ✅ 门店毛收入 90%
- ✅ 一级分佣（直推）10% 计算正确
- ✅ 二级分佣（间推）5% 计算正确
- ✅ 无推荐人订单不产生分佣
- ✅ 分佣记录创建成功
- ✅ 分佣状态为 FROZEN（待结算）
- ✅ 按受益人汇总正确
- ✅ 门店净利润 = 毛收入 - 分佣支出

### 5. 分佣明细验证
**C1（张三）的分佣：**
- ✅ 一级分佣：推荐C2、C3、C7，共3笔
- ✅ 二级分佣：C2推荐C4、C5，C3推荐C6，共3笔
- ✅ 总分佣金额正确

**C2（李四）的分佣：**
- ✅ 一级分佣：推荐C4、C5，共2笔
- ✅ 无二级分佣

**C3（王五）的分佣：**
- ✅ 一级分佣：推荐C6，共1笔
- ✅ 无二级分佣

### 6. 失败场景
- ✅ 人数不足时拼团失败
- ✅ 实例状态更新为 FAILED
- ✅ 失败原因记录正确

### 7. 统计查询
- ✅ 实例状态统计正确（SUCCESS/FAILED/ACTIVE）
- ✅ 订单统计正确（笔数、金额）
- ✅ 分佣统计正确（笔数、金额、状态）
- ✅ 详情数据完整

### 8. 分佣结算
- ✅ 待结算分佣查询正确
- ✅ 状态更新为 SETTLED
- ✅ 结算时间记录正确
- ✅ 按受益人汇总可提现金额
- ✅ 结算后用户可提现

## 注意事项

1. **数据清理**: 脚本会自动清理测试数据，不会影响生产数据
2. **租户隔离**: 使用测试租户 `000000`，与其他租户隔离
3. **幂等性**: 可以重复执行，每次都会清理旧数据
4. **依赖检查**: 确保已运行课程商品种子脚本（`seed-course-products.ts`）

## 扩展测试

如果需要测试其他场景，可以修改脚本：

### 测试不同商品
```typescript
const COURSE_PRODUCT_ID = 'course-dance-001'; // 舞蹈课
const COURSE_SKU_ID = 'course-dance-001-';
```

### 测试不同拼团规则
```typescript
rules: {
  price: 800,
  minCount: 4,
  maxCount: 6,
  leaderDiscount: 100,
  ...
}
```

### 添加更多用户
```typescript
const users = {
  c1: { ... },
  c2: { ... },
  ...
  c10: { id: 'user-c10', name: '用户10', phone: '13800000010' },
};
```

## 故障排查

### 问题 1: 商品不存在
**错误**: `Product not found`
**解决**: 先运行课程商品种子脚本
```bash
cd apps/backend
npx ts-node prisma/seed-course-products.ts
```

### 问题 2: 租户不存在
**错误**: `Tenant not found`
**解决**: 确保租户 `000000` 已创建

### 问题 3: 模板不存在
**错误**: `Template not found`
**解决**: 运行营销模板重置脚本
```bash
cd apps/backend
npx ts-node prisma/reset-marketing-templates.ts
```

## 相关文档

- [课程商品种子数据指南](./COURSE_PRODUCTS_SEED_GUIDE.md)
- [营销模板重置指南](./MARKETING_RESET_GUIDE.md)
- [营销活动配置指南](./MARKETING_CONFIG_GUIDE.md)

## 常见问题与解决方案

### 问题 1: TypeScript 编译错误
**错误信息**:
```
error TS7018: Object literal's property 'referrerId' implicitly has an 'any' type.
```

**原因**: 用户对象缺少明确的类型定义

**解决方案**: 已在脚本中添加 `TestUser` 接口定义
```typescript
interface TestUser {
  id: string;
  name: string;
  phone: string;
  referralCode: string;
  referrerId: string | null;
}
```

### 问题 2: 外键约束错误
**错误信息**:
```
Foreign key constraint violated: `fin_commission_beneficiary_id_fkey (index)`
```

**原因**: 尝试创建分佣记录时，受益人（beneficiaryId）在 `ums_member` 表中不存在

**解决方案**: 
1. 确保 `initTestUsers()` 在创建分佣前执行
2. 脚本已优化用户创建逻辑，会自动处理手机号冲突
3. 清理数据时按正确顺序删除（先删除分佣，最后删除用户）

### 问题 3: 手机号唯一约束冲突
**错误信息**:
```
Unique constraint failed on the fields: (`mobile`)
```

**原因**: 测试用户的手机号已存在于数据库

**解决方案**: 脚本已自动处理，会先删除旧记录再创建新记录
```typescript
const existingByMobile = await prisma.umsMember.findUnique({
  where: { mobile: user.phone },
});

if (existingByMobile && existingByMobile.memberId !== user.id) {
  await prisma.umsMember.delete({
    where: { memberId: existingByMobile.memberId },
  });
}
```

### 问题 4: 数据库连接失败
**错误信息**:
```
Can't reach database server
```

**解决方案**:
1. 检查 `.env` 文件中的数据库配置
2. 确保数据库服务正在运行
3. 验证数据库连接字符串格式正确

### 问题 5: 分佣配置不存在
**错误信息**: 分佣计算结果为 0

**解决方案**: 脚本会自动创建分佣配置，如果仍有问题，手动检查：
```sql
SELECT * FROM sys_dist_config WHERE tenant_id = '000000';
```

### 问题 6: 测试数据残留
**现象**: 重复运行测试时出现数据冲突

**解决方案**: 脚本开始时会自动清理，如果需要手动清理：
```sql
-- 按顺序删除
DELETE FROM fin_commission WHERE tenant_id = '000000';
DELETE FROM oms_order_item WHERE order_id IN (SELECT id FROM oms_order WHERE member_id LIKE 'user-c%');
DELETE FROM oms_order WHERE member_id LIKE 'user-c%';
DELETE FROM play_instance WHERE member_id LIKE 'user-c%';
DELETE FROM store_play_config WHERE service_id = 'course-vocal-001';
DELETE FROM ums_member WHERE member_id LIKE 'user-c%';
```

## 测试成功标志

当看到以下输出时，表示测试完全成功：

```
📊 测试结果统计:
   总场景数: 8
   成功: 8
   失败: 0

💼 关键业务指标:
   📈 收入分析:
      订单总收入: 4030.00
      平台抽成: 403.00 (10%)
      门店毛收入: 3627.00
      分佣支出: 442.00
      门店净利润: 3185.00

🎉 测试完成！
```

## 性能基准

在标准开发环境下，完整测试应在 **5-10 秒**内完成：
- 数据清理：< 1秒
- 用户创建：< 1秒
- 营销配置：< 1秒
- 拼团流程：2-3秒
- 分佣计算：1-2秒
- 统计查询：< 1秒
- 分佣结算：< 1秒

如果执行时间明显超过这个范围，可能需要检查：
- 数据库性能
- 网络延迟
- 索引是否正确创建
